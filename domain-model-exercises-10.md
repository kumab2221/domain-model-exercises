# ドメインモデル抽出 — 練習問題と模範解答（第10回）

---

## 【問題 1】初級 — 美容室予約・顧客管理システム

### 要件

> 美容室の予約・顧客管理システムを設計してください。
>
> - 美容室にはスタイリストが複数在籍する。各スタイリストには氏名、指名料、得意メニューがある。
> - メニューには施術名、施術時間（分）、料金がある。メニューは複数組み合わせて予約できる（例: カット + カラー + トリートメント）。
> - スタイリストごとにシフト（出勤日・勤務時間帯）が設定されている。
> - 顧客はスタイリストを指名して予約するか、指名なしで予約できる。指名なしの場合、空いているスタイリストが自動で割り当てられる。
> - 予約時間は選択したメニューの合計施術時間に基づいて自動計算される。
> - 同じスタイリストの同じ時間帯に予約が重複してはならない。
> - 顧客には「カルテ」がある。カルテには過去の施術履歴、髪質メモ、アレルギー情報、好みの仕上がりなどが記録される。
> - 会計は施術完了後に行う。メニュー料金 + 指名料の合計が請求される。ポイントカードがあり、来店ごとにポイントが貯まる。

**問い**: エンティティ、値オブジェクト、集約、ドメインイベントを抽出してください。

---

### 模範解答 1

#### エンティティ

| エンティティ | 識別子 | 主な属性・関連 |
|---|---|---|
| スタイリスト (Stylist) | stylistId | 氏名, 指名料, 得意メニュー |
| メニュー (Menu) | menuId | 施術名, 施術時間, 料金 |
| 顧客 (Customer) | customerId | 氏名, 電話番号, メールアドレス |
| カルテ (CustomerCard) | cardId (= customerId) | 顧客, 髪質メモ, アレルギー情報, 好みの仕上がり |
| 予約 (Appointment) | appointmentId | 顧客, スタイリスト, メニューリスト, 予約日時, 施術時間合計, ステータス |
| 施術履歴 (ServiceHistory) | historyId | 顧客, スタイリスト, メニューリスト, 施術日, 施術メモ |
| 会計 (Bill) | billId | 予約, メニュー料金合計, 指名料, 合計金額, ポイント付与数 |

#### 値オブジェクト

| 値オブジェクト | 構成要素 | 理由 |
|---|---|---|
| シフト (Shift) | 出勤日, 勤務開始時刻, 勤務終了時刻 | スタイリストの勤務スケジュールの一行 |
| 予約ステータス (AppointmentStatus) | 予約済み/来店/施術中/完了/キャンセル/No-Show | 列挙型 |
| 金額 (Money) | 数値, 通貨 | 汎用値オブジェクト |
| 施術時間 (Duration) | 分数 | バリデーション付きの値 |
| アレルギー情報 (AllergyInfo) | アレルギー物質, 備考 | 安全に関わる重要な値 |

#### 集約

| 集約ルート | 含まれるもの | 整合性のルール |
|---|---|---|
| **Stylist** | Stylist + Shift リスト | スタイリストとシフトは一体管理。空き判定の基盤 |
| **Menu** | Menu 単体 | メニューマスタ |
| **Customer** | Customer + CustomerCard | 顧客とカルテは一体。カルテは顧客に1つ |
| **Appointment** | Appointment 単体 | 予約の管理。スタイリストの時間重複チェックは横断チェック |
| **ServiceHistory** | ServiceHistory 単体 | 施術の記録。蓄積データ |
| **Bill** | Bill 単体 | 会計の記録 |

#### ドメインイベント

- `AppointmentBooked` — 予約が作成された
- `AppointmentCancelled` — 予約がキャンセルされた
- `CustomerArrived` — 顧客が来店した
- `ServiceStarted` — 施術が開始された
- `ServiceCompleted` — 施術が完了した（→ 施術履歴の記録、会計の作成）
- `PaymentCompleted` — 会計が完了した（→ ポイント付与）
- `CustomerNoShow` — 顧客が無断キャンセルした

#### 解説ポイント

- **カルテを Customer に含める理由**: カルテは顧客と1:1であり、顧客なしに存在しない。アレルギー情報は施術前の確認に必須であり、顧客情報と一体で扱うのが自然。
- **予約の重複チェック**: スタイリストの既存予約と新規予約の時間帯が重複しないかを確認する必要がある。Appointment 集約単体では他の予約を参照できないため、ドメインサービス（空き枠判定サービス）で横断チェックする。
- **施術時間の自動計算**: 選択メニューの施術時間を合算する。これは予約作成時のロジックであり、Appointment の値として保持する。

---

## 【問題 2】中級 — オークションプラットフォーム

### 要件

> オンラインオークションプラットフォームを設計してください。
>
> - 出品者はオークションに商品を出品する。商品には商品名、説明、画像（複数）、カテゴリ、商品状態（新品/中古/ジャンク）がある。
> - オークションには開始価格、即決価格（任意）、オークション期間（開始日時〜終了日時）、最低入札単位がある。
> - 入札者は現在の最高額以上（最低入札単位刻み）で入札できる。入札は取り消せない。
> - 「自動入札」機能がある。入札者は上限額を設定し、他者が入札するたびにシステムが最低入札単位で自動的に入札する（上限額まで）。
> - 即決価格が設定されている場合、即決価格で入札するとオークションは即座に終了する。
> - オークション終了時に最高額入札者が落札者となる。入札がなければ「流札」。
> - オークション終了の5分前に入札があった場合、終了時刻が5分延長される（スナイプ防止）。
> - 落札後、落札者は3日以内に支払いを行う。支払期限を過ぎると落札が取り消され、次点入札者に権利が移る。
> - 支払い完了後、出品者は商品を発送する。取引完了後、双方が評価を行う。
> - 出品者・入札者には「評価スコア」がある。過去の取引での評価（良い/普通/悪い）から算出される。

**問い**: エンティティ、値オブジェクト、集約（境界の理由も）、ドメインイベント、ドメインサービスを抽出してください。

---

### 模範解答 2

#### エンティティ

| エンティティ | 識別子 | 主な属性・関連 |
|---|---|---|
| ユーザー (User) | userId | 氏名, メールアドレス, 評価スコア |
| オークション (Auction) | auctionId | 出品者, 商品情報, 開始価格, 即決価格, 期間, 最低入札単位, 現在の最高額, ステータス |
| 入札 (Bid) | bidId | 入札者, オークション, 入札額, 入札日時, 自動入札フラグ |
| 自動入札設定 (AutoBidSetting) | settingId | 入札者, オークション, 上限額 |
| 落札取引 (WinningTransaction) | transactionId | オークション, 落札者, 落札額, 支払期限, 支払ステータス, 発送ステータス |
| 評価 (Rating) | ratingId | 取引, 評価者, 被評価者, 評価ランク, コメント |

#### 値オブジェクト

| 値オブジェクト | 構成要素 | 理由 |
|---|---|---|
| 商品情報 (ItemInfo) | 商品名, 説明, 画像URLリスト, カテゴリ, 商品状態 | 出品された商品の詳細 |
| 商品状態 (ItemCondition) | 新品/中古/ジャンク | 列挙型 |
| オークション期間 (AuctionPeriod) | 開始日時, 終了日時 | 延長ロジックを持つ値。「残り5分以内に入札→5分延長」 |
| オークションステータス (AuctionStatus) | 出品中/開催中/落札/流札/取消 | 列挙型 |
| 支払ステータス (PaymentStatus) | 未払い/支払済み/期限切れ | 列挙型 |
| 発送ステータス (ShippingStatus) | 未発送/発送済み/受取確認 | 列挙型 |
| 評価ランク (RatingGrade) | 良い/普通/悪い | 列挙型 |
| 金額 (Money) | 数値, 通貨 | 汎用値オブジェクト |

#### 集約と境界の理由

| 集約ルート | 含まれるもの | 境界の理由 |
|---|---|---|
| **User** | User 単体 | ユーザー基本情報と評価スコアの管理 |
| **Auction** | Auction + AuctionPeriod | オークションの核心。現在の最高額、終了時刻の延長管理はここ。**入札（Bid）は含めない**（後述） |
| **Bid** | Bid 単体 | 入札は高頻度で発生する。Auction 集約に含めると、入札のたびにオークション全体をロックすることになる。独立集約にして、入札時に Auction の最高額を楽観ロックで更新する |
| **AutoBidSetting** | AutoBidSetting 単体 | 自動入札の設定。入札者×オークションの単位。Auction とは参照関係 |
| **WinningTransaction** | WinningTransaction 単体 | 落札後の取引プロセス（支払い→発送→受取）は Auction とは独立したライフサイクル |
| **Rating** | Rating 単体 | 評価は取引完了後に独立して管理 |

#### ドメインイベント

- `AuctionCreated` — オークションが出品された
- `AuctionStarted` — オークションが開始された
- `BidPlaced` — 入札が行われた（→ 自動入札の発動チェック、終了時刻延長チェック）
- `AutoBidTriggered` — 自動入札が発動された
- `AuctionEndTimeExtended` — 終了時刻が延長された（スナイプ防止）
- `AuctionWon` — 落札された（→ 取引作成）
- `AuctionEndedWithNoBids` — 流札した
- `InstantBuyExecuted` — 即決価格で落札された
- `PaymentCompleted` — 支払いが完了した（→ 出品者に発送依頼）
- `PaymentDeadlineExpired` — 支払期限が超過した（→ 次点入札者への繰り上げ）
- `ItemShipped` — 商品が発送された
- `ItemReceived` — 商品が受け取られた
- `RatingPosted` — 評価が投稿された

#### ドメインサービス

| サービス | 責務 |
|---|---|
| **入札処理サービス (BidProcessingService)** | 入札の妥当性チェック（最低入札単位、現在の最高額以上か）、Auction の最高額更新、自動入札の発動判定を一連で処理する。Auction 集約と Bid 集約、AutoBidSetting をまたぐ |
| **自動入札エンジン (AutoBidEngine)** | 新規入札が入るたびに、同じオークションの AutoBidSetting を確認し、上限額内で最低入札単位の自動入札を生成する。複数の自動入札設定がある場合の競合解決も担う |
| **オークション終了処理サービス (AuctionClosingService)** | 終了時刻到達時に、最高額入札者を落札者として確定し、WinningTransaction を作成する。入札がなければ流札処理。スケジューラと連携 |
| **次点繰り上げサービス (RunnerUpPromotionService)** | 落札者の支払期限超過時に、次点入札者に落札権を移管する。新しい WinningTransaction を作成し、支払期限を設定する |
| **評価スコア算出サービス (ReputationScoreService)** | 評価が投稿されるたびに、ユーザーの評価スコアを再計算する。Rating の集計と User の評価スコア更新 |

#### 解説ポイント

- **Bid を Auction 集約に含めない理由**: 人気オークションでは入札が秒単位で発生する。Auction 集約に全 Bid を含めると、入札のたびに集約全体をロードしてロックする必要がある。Bid を独立集約にし、Auction の「現在の最高額」だけを楽観ロックで更新する方がスケーラブル。
- **スナイプ防止の終了時刻延長**: AuctionPeriod が「終了5分前の入札で5分延長」のロジックを持つ。BidPlaced イベントの発生時刻と現在の終了時刻を比較し、延長が必要なら AuctionEndTimeExtended を発行。
- **次点繰り上げの連鎖**: 次点入札者も支払期限を超過した場合、さらに次点に繰り上がる。理論上はN回繰り上がる可能性がある。WinningTransaction を新規作成するたびに支払期限を設定するループ的な処理。

---

## 【問題 3】上級 — 電力需給管理・取引プラットフォーム

### 要件

> 電力の需給管理と取引を行うプラットフォームを設計してください。
>
> **発電・需要管理**
> - 発電事業者は発電所を登録する。発電所には名称、発電方式（太陽光/風力/火力/水力）、最大出力（kW）、所在地がある。
> - 発電所は30分単位で発電量の「計画値」を提出する（翌日分を前日に提出）。
> - 実際の発電量は30分単位で自動計測され、「実績値」として記録される。
> - 需要家（電力を使う企業）も同様に、30分単位の需要「計画値」と「実績値」がある。
>
> **インバランス管理**
> - 計画値と実績値の差分を「インバランス」と呼ぶ。インバランスは30分コマ単位で算出される。
> - インバランスが発生した場合、インバランス料金が課される。料金はその時間帯のインバランス単価（市場連動）で計算される。
>
> **電力取引**
> - 発電事業者と需要家の間で電力の売買契約が結ばれる。契約には供給期間、契約電力量（kW）、単価がある。
> - スポット市場での取引もある。翌日の30分コマ単位で、売り入札（発電余剰分）と買い入札（不足分）を出し、市場でマッチングされる。
> - スポット市場はブラインドオークション方式で、売り入札と買い入札の交差点で約定価格が決まる。
>
> **精算**
> - 月次で以下を精算する:
>   - 相対契約に基づく電力料金
>   - スポット市場の約定分の精算
>   - インバランス料金の精算
> - 精算書には各項目の内訳（30分コマ単位）が記載される。

**問い**: エンティティ、値オブジェクト、集約（境界の理由と注意点）、ドメインイベント、ドメインサービスを抽出してください。特に「30分コマ単位の計画・実績管理」「スポット市場のマッチング」「インバランスの算出と精算」の設計判断を説明してください。

---

### 模範解答 3

#### エンティティ

| エンティティ | 識別子 | 主な属性・関連 |
|---|---|---|
| 発電事業者 (Generator) | generatorId | 事業者名, 連絡先 |
| 発電所 (PowerPlant) | plantId | 名称, 発電方式, 最大出力, 所在地, 発電事業者 |
| 需要家 (Consumer) | consumerId | 企業名, 連絡先 |
| 発電計画 (GenerationPlan) | planId | 発電所, 対象日, 30分コマごとの計画値リスト |
| 発電実績 (GenerationActual) | actualId | 発電所, 対象日, 30分コマごとの実績値リスト |
| 需要計画 (DemandPlan) | planId | 需要家, 対象日, 30分コマごとの計画値リスト |
| 需要実績 (DemandActual) | actualId | 需要家, 対象日, 30分コマごとの実績値リスト |
| 相対契約 (BilateralContract) | contractId | 発電事業者, 需要家, 供給期間, 契約電力量, 単価 |
| スポット入札 (SpotBid) | bidId | 事業者(発電or需要), 対象日, コマ番号, 売/買, 入札量(kWh), 入札価格 |
| 約定 (SpotTransaction) | transactionId | 売り側, 買い側, 対象コマ, 約定量, 約定価格 |
| インバランス記録 (ImbalanceRecord) | recordId | 事業者, 対象日, コマ番号, 計画値, 実績値, 差分, インバランス単価, インバランス料金 |
| 月次精算書 (MonthlySettlement) | settlementId | 事業者, 対象年月, 相対契約精算額, スポット精算額, インバランス精算額, 合計 |

#### 値オブジェクト

| 値オブジェクト | 構成要素 | 理由 |
|---|---|---|
| 30分コマ (TimeSlot) | 日付, コマ番号(1〜48) | 電力取引の最小時間単位 |
| コマ別値 (SlotValue) | コマ番号, 値(kWh) | 計画/実績の一行 |
| 発電方式 (GenerationType) | 太陽光/風力/火力/水力 | 列挙型 |
| 電力量 (EnergyAmount) | 数値, 単位(kWh/kW) | バリデーション付きの値 |
| 単価 (UnitPrice) | 金額/kWh | 取引の価格単位 |
| 金額 (Money) | 数値, 通貨 | 汎用値オブジェクト |
| 供給期間 (SupplyPeriod) | 開始日, 終了日 | 契約期間 |
| 入札種別 (BidSide) | 売り/買い | 列挙型 |
| 精算明細 (SettlementLine) | 項目種別, コマ番号, 電力量, 単価, 金額 | 精算書の一行 |

#### 集約と境界の理由

| 集約ルート | 含まれるもの | 境界の理由・注意点 |
|---|---|---|
| **PowerPlant** | PowerPlant 単体 | 発電所のマスタ情報 |
| **Generator** | Generator 単体 | 発電事業者の情報 |
| **Consumer** | Consumer 単体 | 需要家の情報 |
| **GenerationPlan** | GenerationPlan + SlotValue リスト(48コマ) | 1日分の発電計画は一体で提出・管理される。48コマの整合性（合計が最大出力を超えない等）をこの中で保証 |
| **GenerationActual** | GenerationActual + SlotValue リスト(48コマ) | 実績値は計測システムから自動登録。計画と同じ粒度で独立管理 |
| **DemandPlan** | DemandPlan + SlotValue リスト | 需要計画。発電計画と同構造 |
| **DemandActual** | DemandActual + SlotValue リスト | 需要実績 |
| **BilateralContract** | BilateralContract 単体 | 相対契約は独立したライフサイクル |
| **SpotBid** | SpotBid 単体 | 入札は個別に管理。マッチング処理の入力 |
| **SpotTransaction** | SpotTransaction 単体 | 約定結果。マッチング処理の出力 |
| **ImbalanceRecord** | ImbalanceRecord 単体 | コマ単位のインバランス記録。大量に生成されるため独立管理 |
| **MonthlySettlement** | MonthlySettlement + SettlementLine リスト | 月次精算書と明細は一体で確定 |

#### ドメインイベント

- `GenerationPlanSubmitted` — 発電計画が提出された
- `GenerationActualRecorded` — 発電実績が記録された
- `DemandPlanSubmitted` — 需要計画が提出された
- `DemandActualRecorded` — 需要実績が記録された
- `BilateralContractSigned` — 相対契約が締結された
- `SpotBidSubmitted` — スポット入札が提出された
- `SpotMarketCleared` — スポット市場のマッチングが完了した
- `SpotTransactionSettled` — スポット約定が確定した
- `ImbalanceCalculated` — インバランスが算出された
- `ImbalancePricePublished` — インバランス単価が公表された
- `MonthlySettlementGenerated` — 月次精算書が生成された

#### ドメインサービス

| サービス | 責務 |
|---|---|
| **スポット市場マッチングサービス (SpotMarketClearingService)** | 翌日の各コマに対して、売り入札と買い入札を価格順にソートし、需給曲線の交差点で約定価格・約定量を決定する。ブラインドオークションのロジック |
| **インバランス算出サービス (ImbalanceCalculationService)** | 各事業者の計画値と実績値をコマ単位で比較し、差分（インバランス）を算出。インバランス単価を掛けてインバランス料金を計算。GenerationPlan/Actual, DemandPlan/Actual, インバランス単価を横断参照 |
| **月次精算サービス (MonthlySettlementService)** | 当月の相対契約精算（契約電力量×単価）、スポット約定精算（約定量×約定価格）、インバランス精算を合算し、精算書を生成する。BilateralContract, SpotTransaction, ImbalanceRecord を横断集計 |
| **発電計画検証サービス (GenerationPlanValidationService)** | 提出された発電計画のコマ別値が最大出力を超えていないか、前日提出期限を守っているかを検証する |

#### 設計判断の解説

**1. 30分コマ単位の計画・実績管理**

```
1日 = 48コマ（00:00-00:30, 00:30-01:00, ..., 23:30-24:00）

発電計画（前日提出）:
  GenerationPlan {
    plantId, date: 2025-03-01,
    slots: [
      { slot: 1, value: 500kWh },  // 00:00-00:30
      { slot: 2, value: 480kWh },  // 00:30-01:00
      ...
      { slot: 48, value: 520kWh }  // 23:30-24:00
    ]
  }

発電実績（自動計測）:
  GenerationActual {
    plantId, date: 2025-03-01,
    slots: [
      { slot: 1, value: 510kWh },  // 計画: 500, 実績: 510 → インバランス: +10
      ...
    ]
  }
```

- 計画と実績を別集約にする理由: 計画は前日に提出されて確定。実績は当日のリアルタイム計測で逐次更新される。ライフサイクルが異なる
- 48コマの SlotValue リストは1日分で固定長。集約サイズとして適切

**2. スポット市場のマッチング**

```
特定コマ（例: 翌日 12:00-12:30）に対する入札:

売り入札（安い順にソート）:
  発電事業者A: 100kWh @ 10円
  発電事業者B: 200kWh @ 12円
  発電事業者C: 150kWh @ 15円

買い入札（高い順にソート）:
  需要家X: 150kWh @ 20円
  需要家Y: 100kWh @ 14円
  需要家Z: 50kWh @ 11円

需給曲線の交差:
  累積供給: A(100) → A+B(300) → A+B+C(450)
  累積需要: X(150) → X+Y(250) → X+Y+Z(300)
  
  交差点 → 約定量: 300kWh, 約定価格: 12円（限界価格）

  約定:
    A → X: 100kWh @ 12円
    B → X: 50kWh @ 12円
    B → Y: 100kWh @ 12円
    B → Z: 50kWh @ 12円
```

- マッチングは翌日の全48コマに対してバッチで実行される
- SpotMarketClearingService が全入札を読み込み、コマごとに約定を決定して SpotTransaction を生成
- この処理は1日1回（前日の特定時刻）実行される確定的なバッチ処理

**3. インバランスの算出と精算**

```
コマごとのインバランス算出:
  インバランス = 実績値 - 計画値
    正（余剰）: 計画より多く発電/少なく消費 → 余った電力
    負（不足）: 計画より少なく発電/多く消費 → 足りない電力

  インバランス料金 = |インバランス| × インバランス単価

月次精算:
  精算額 = Σ(相対契約精算) + Σ(スポット約定精算) + Σ(インバランス精算)

  相対契約精算: 契約電力量 × 単価 × 対象日数
  スポット精算: Σ(約定量 × 約定価格) for 全コマ
  インバランス精算: Σ(インバランス料金) for 全コマ
```

- ImbalanceRecord はコマ単位×事業者単位で大量に生成される（1事業者あたり月間 48×30 = 1,440レコード）。独立集約として書き込み性能を確保
- インバランス単価は外部（電力系統運用者）から公表される値。システム内で算出するものではない
- 月次精算は大量データの集計処理。バッチジョブで実行し、MonthlySettlement を生成
