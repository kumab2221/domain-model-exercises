# ドメインモデル抽出 — 練習問題と模範解答（第7回）

---

## 【問題 1】初級 — レシピ共有SNS

### 要件

> レシピ共有SNSを設計してください。
>
> - ユーザーはアカウントを作成し、プロフィール（表示名、自己紹介、アイコン画像）を設定する。
> - ユーザーはレシピを投稿できる。レシピにはタイトル、説明、調理時間、難易度（簡単/普通/本格）、カテゴリ（和食/洋食/中華等）、サムネイル画像がある。
> - レシピには材料リスト（材料名、分量、単位）と手順リスト（ステップ番号、説明テキスト、写真）がある。
> - レシピの分量は「○人前」の基準人数が設定され、閲覧者が人数を変えると材料の分量が自動計算される。
> - ユーザーは他のユーザーのレシピに「いいね」を付けられる。同じレシピに2回以上「いいね」はできない。
> - ユーザーはレシピにコメントを投稿できる。コメントにはテキストと写真（「つくれぽ」）を添付できる。
> - ユーザーは他のユーザーを「フォロー」できる。フォローしたユーザーの新着レシピがタイムラインに表示される。
> - ユーザーはレシピを「ブックマーク」して後で見返せる。

**問い**: エンティティ、値オブジェクト、集約、ドメインイベントを抽出してください。

---

### 模範解答 1

#### エンティティ

| エンティティ | 識別子 | 主な属性・関連 |
|---|---|---|
| ユーザー (User) | userId | 表示名, 自己紹介, アイコン画像URL |
| レシピ (Recipe) | recipeId | タイトル, 説明, 調理時間, 難易度, カテゴリ, サムネイル, 基準人数, 投稿者 |
| コメント (Comment) | commentId | レシピ, 投稿者, テキスト, 写真URL(nullable) |

#### 値オブジェクト

| 値オブジェクト | 構成要素 | 理由 |
|---|---|---|
| 材料 (Ingredient) | 材料名, 分量, 単位 | レシピ内の一行。同じ内容なら等価 |
| 手順 (Step) | ステップ番号, 説明テキスト, 写真URL | レシピ内の一行 |
| 難易度 (Difficulty) | 簡単/普通/本格 | 列挙型 |
| カテゴリ (RecipeCategory) | 和食/洋食/中華等 | 列挙型 |
| 基準人数 (ServingSize) | 人数(正の整数) | バリデーション付きの値 |
| いいね (Like) | ユーザーID, レシピID, 日時 | 関係の記録。独立ライフサイクル不要 |
| フォロー (Follow) | フォロワーID, フォロイーID | 関係の記録 |
| ブックマーク (Bookmark) | ユーザーID, レシピID, 日時 | 関係の記録 |

#### 集約

| 集約ルート | 含まれるもの | 整合性のルール |
|---|---|---|
| **User** | User 単体 | ユーザー情報の管理 |
| **Recipe** | Recipe + Ingredient リスト + Step リスト | レシピの内容は一体で編集される。材料・手順はレシピに従属 |
| **Comment** | Comment 単体 | コメントは独立したライフサイクル。レシピ集約をロックせずに追加可能 |

#### いいね・フォロー・ブックマークの扱い

これらは「関係」を表すデータであり、典型的な集約の枠に収まりにくい。

- **いいね**: Recipe 集約に含めると、人気レシピへの「いいね」が集中して競合する。独立したテーブル（ユーザーID × レシピID のユニーク制約）で管理し、集約外で扱うのが実用的。
- **フォロー**: ユーザー間の関係。どちらの User 集約にも属さない。独立したテーブルで管理。
- **ブックマーク**: ユーザーの個人操作。User 集約に含めることもできるが、量が増えると肥大化するため、独立テーブルが無難。

いいね数・フォロワー数などの集計値は非正規化（カウンタ保持）で対応し、イベント駆動で更新するのが一般的。

#### ドメインイベント

- `RecipePosted` — レシピが投稿された（→ フォロワーのタイムラインに反映）
- `RecipeLiked` — レシピにいいねされた
- `RecipeUnliked` — いいねが取り消された
- `CommentPosted` — コメントが投稿された
- `UserFollowed` — ユーザーがフォローされた
- `UserUnfollowed` — フォローが解除された
- `RecipeBookmarked` — レシピがブックマークされた

#### 解説ポイント

- **「いいね」を値オブジェクトとした理由**: いいね自体に独立したライフサイクル（作成後に変更されること）がない。しかし、集約のどこに属すかが難しいため、実装上は独立したリポジトリで管理するケースが多い。DDD の戦術パターンに無理に当てはめず、実装の都合を優先してよい。
- **分量の自動計算**: 基準人数と材料の分量があれば、閲覧時に動的計算できる。これはプレゼンテーション層のロジックであり、ドメインモデルに持たせる必要はない。

---

## 【問題 2】中級 — 倉庫在庫管理システム（WMS）

### 要件

> 倉庫の在庫管理システム（WMS: Warehouse Management System）を設計してください。
>
> - 倉庫には複数のロケーション（棚）がある。各ロケーションにはロケーションコード（例: A-01-03）、ゾーン（常温/冷蔵/冷凍）、最大保管数がある。
> - 商品（SKU）にはSKUコード、商品名、カテゴリ、保管条件（常温/冷蔵/冷凍）、重量、サイズがある。
> - 商品は保管条件に合ったゾーンのロケーションにのみ配置できる。
> - **入庫**: 発注に基づいて商品が倉庫に届く。入庫時に検品（数量確認・品質チェック）を行い、合格した商品をロケーションに配置する。不合格品は返品エリアに分離する。
> - **出庫**: 出荷指示に基づいてロケーションから商品をピッキングする。ピッキングリストが生成され、作業者に割り当てられる。
> - ピッキングは「先入れ先出し（FIFO）」で行う。入庫日が古いロットから優先的にピッキングする。
> - **在庫移動**: ロケーション間で在庫を移動できる（棚替え）。
> - **棚卸し**: 定期的に実在庫とシステム上の在庫を照合する。差異がある場合は調整（増減）を記録する。
> - 各商品のロケーション別在庫数がリアルタイムで把握できること。
> - 在庫がしきい値を下回った場合、自動的にアラートが発行される。

**問い**: エンティティ、値オブジェクト、集約（境界の理由も）、ドメインイベント、ドメインサービスを抽出してください。

---

### 模範解答 2

#### エンティティ

| エンティティ | 識別子 | 主な属性・関連 |
|---|---|---|
| ロケーション (Location) | locationId | ロケーションコード, ゾーン, 最大保管数 |
| 商品 (SKU) | skuId | SKUコード, 商品名, カテゴリ, 保管条件, 重量, サイズ |
| 在庫ロット (InventoryLot) | lotId | 商品, ロケーション, 入庫日, 数量 |
| 入庫 (Receiving) | receivingId | 発注番号, 入庫日, 検品結果リスト |
| 出荷指示 (ShipmentOrder) | shipmentOrderId | 出荷先, 出荷明細リスト, ステータス |
| ピッキングリスト (PickList) | pickListId | 出荷指示, 作業者, ピッキング明細リスト, ステータス |
| 棚卸し (StockCount) | countId | 実施日, ロケーション, 棚卸し明細リスト, ステータス |

#### 値オブジェクト

| 値オブジェクト | 構成要素 | 理由 |
|---|---|---|
| ロケーションコード (LocationCode) | ゾーン-列-段 の文字列 | フォーマットルール付きの値 |
| ゾーン (Zone) | 常温/冷蔵/冷凍 | 列挙型 |
| 保管条件 (StorageCondition) | 常温/冷蔵/冷凍 | 列挙型 |
| 重量 (Weight) | 数値, 単位(kg/g) | バリデーション付きの値 |
| サイズ (Dimensions) | 縦, 横, 高さ, 単位 | 物理寸法の組 |
| 検品結果 (InspectionResult) | 商品, 数量, 合否, 不合格理由 | 入庫検品の一行 |
| 出荷明細 (ShipmentLine) | 商品, 数量 | 出荷指示の一行 |
| ピッキング明細 (PickItem) | 商品, ロケーション, ロット, 数量, ピッキング済みフラグ | ピッキングの一行 |
| 棚卸し明細 (CountLine) | 商品, システム在庫数, 実在庫数, 差異数 | 棚卸しの一行 |
| 在庫調整 (StockAdjustment) | 商品, ロケーション, 調整数量, 理由 | 棚卸し差異の調整記録 |

#### 集約と境界の理由

| 集約ルート | 含まれるもの | 境界の理由 |
|---|---|---|
| **Location** | Location 単体 | ロケーションのマスタ情報。保管数上限の管理 |
| **SKU** | SKU 単体 | 商品マスタ情報 |
| **InventoryLot** | InventoryLot 単体 | 在庫の最小管理単位。入庫ごとにロットが作られ、個別に数量が増減する。FIFO ピッキングのためにロット単位の管理が必要。**これが在庫管理の核心的な集約。** |
| **Receiving** | Receiving + InspectionResult | 入庫と検品は一体のプロセス。検品結果に基づいてロットが生成される |
| **ShipmentOrder** | ShipmentOrder + ShipmentLine | 出荷指示と明細は一体。ステータス管理（指示中→ピッキング中→出荷完了）|
| **PickList** | PickList + PickItem | ピッキングリストと明細は一体。作業者への割当・進捗管理 |
| **StockCount** | StockCount + CountLine + StockAdjustment | 棚卸しの実施と結果・調整は一体で管理 |

#### ドメインイベント

- `GoodsReceived` — 商品が入庫された
- `InspectionCompleted` — 検品が完了した（→ 合格品のロット生成トリガー）
- `InventoryStocked` — 在庫がロケーションに配置された
- `ShipmentOrderCreated` — 出荷指示が作成された（→ ピッキングリスト生成トリガー）
- `PickListAssigned` — ピッキングリストが作業者に割り当てられた
- `ItemPicked` — 商品がピッキングされた（→ 在庫減算）
- `PickListCompleted` — ピッキングが完了した
- `InventoryMoved` — 在庫がロケーション間で移動された
- `StockCountStarted` — 棚卸しが開始された
- `StockCountCompleted` — 棚卸しが完了した
- `StockAdjusted` — 在庫が調整された
- `LowStockAlertTriggered` — 在庫がしきい値を下回った

#### ドメインサービス

| サービス | 責務 |
|---|---|
| **ロケーション割当サービス (LocationAssignmentService)** | 入庫時に商品の保管条件に合致するロケーションの中から、空き容量のあるロケーションを選定する。Location（ゾーン・空き）と SKU（保管条件）を横断参照。 |
| **ピッキング計画サービス (PickPlanningService)** | 出荷指示に基づき、FIFO ルールで各商品のピッキング元ロット・ロケーションを決定し、PickList を生成する。InventoryLot（入庫日・数量）を横断的に参照。 |
| **在庫しきい値監視サービス (StockThresholdMonitorService)** | 在庫変動（出庫・調整）後に商品ごとの総在庫数を確認し、しきい値を下回った場合にアラートを発行する。 |

#### 解説ポイント

- **InventoryLot を独立集約にする理由**: 在庫はロケーション×商品×入庫日の単位で管理される。ロケーション集約や商品集約に含めると、入出庫のたびにそれらの集約全体をロックすることになり、高頻度の在庫操作でパフォーマンスが低下する。
- **FIFO の実現**: PickPlanningService が InventoryLot を入庫日の昇順でソートし、古いロットから必要数量を割り当てる。1つのロットで数量が足りなければ、次のロットに繰り越す。
- **棚卸しの差異調整**: 差異が発生した場合、StockAdjustment を記録すると同時に InventoryLot の数量を修正する。この操作は StockCount 集約から InventoryLot 集約への更新になるため、ドメインイベント経由で結果整合性を取るか、ドメインサービスで同一トランザクションで処理するかは規模に応じて判断。

---

## 【問題 3】上級 — 保険契約管理システム

### 要件

> 生命保険の契約管理システムを設計してください。
>
> **商品・プラン**
> - 保険商品には複数の種類がある（終身保険、定期保険、医療保険、がん保険等）。
> - 各商品には基本保障と、追加できる特約（先進医療特約、入院日額上乗せ等）がある。
> - 保険料は被保険者の年齢、性別、喫煙の有無、保障内容によって算出される。保険料率テーブルは商品ごとに定義されている。
>
> **申込・引受**
> - 顧客は商品と保障内容を選択し、申込書を提出する。申込書には契約者情報、被保険者情報、受取人情報、告知事項（既往歴、現在の健康状態）が含まれる。
> - 告知事項に基づいて引受審査が行われる。審査結果は「標準引受」「条件付き引受（特定疾病不担保等）」「謝絶」のいずれか。
> - 条件付き引受の場合、条件（不担保期間や保険料割増）を付して契約者に提示し、承諾を得る。
>
> **契約管理**
> - 引受後、初回保険料の入金が確認されると契約が成立する。契約には証券番号が付与される。
> - 契約のステータスは「契約中」→「失効」→「復活」や「解約」「満期」と遷移する。
> - 保険料は月払い/年払いで自動引き落とし。2ヶ月滞納すると契約が「失効」する。
> - 失効から3年以内であれば、未払い保険料を支払い健康状態の再告知を経て「復活」できる。
> - 契約者は契約内容の変更（保障額の増減、特約の追加・削除、受取人の変更）を申請できる。
> - 解約時には解約返戻金が支払われる。返戻金は契約年数と払込保険料総額に基づいて計算される。
>
> **保険金請求**
> - 被保険者に保険事故（死亡、入院、手術等）が発生した場合、受取人が保険金を請求する。
> - 請求には事故の種類、発生日、診断書等の書類が必要。
> - 請求に対して支払査定が行われる。査定では、保障内容との照合、免責事由の確認、告知義務違反の調査が行われる。
> - 査定結果は「全額支払い」「減額支払い」「免責（不支払い）」のいずれか。
> - 支払い決定後、受取人に保険金が支払われる。

**問い**: エンティティ、値オブジェクト、集約（境界の理由と注意点）、ドメインイベント、ドメインサービスを抽出してください。特に「引受審査のフロー」「契約の失効と復活」「保険金請求の査定プロセス」の設計判断を説明してください。

---

### 模範解答 3

#### エンティティ

| エンティティ | 識別子 | 主な属性・関連 |
|---|---|---|
| 保険商品 (InsuranceProduct) | productId | 商品名, 種類, 基本保障内容, 特約リスト |
| 保険料率テーブル (PremiumRateTable) | rateTableId | 商品, 年齢区分, 性別, 喫煙区分, 料率 |
| 申込 (Application) | applicationId | 契約者情報, 被保険者情報, 受取人情報, 商品, 保障内容, 告知事項, 申込ステータス |
| 引受審査 (UnderwritingReview) | reviewId | 申込, 審査結果, 引受条件, 審査日 |
| 契約 (Policy) | policyId (証券番号) | 契約者, 被保険者, 受取人リスト, 商品, 保障内容, 保険料, 払込方法, 契約日, ステータス |
| 保険料請求 (PremiumBilling) | billingId | 契約, 対象期間, 請求額, 入金ステータス |
| 保険金請求 (Claim) | claimId | 契約, 請求者, 事故種類, 事故発生日, 提出書類, 請求ステータス |
| 支払査定 (ClaimAssessment) | assessmentId | 保険金請求, 査定結果, 支払金額, 減額理由or免責理由, 査定日 |

#### 値オブジェクト

| 値オブジェクト | 構成要素 | 理由 |
|---|---|---|
| 契約者情報 (PolicyholderInfo) | 氏名, 生年月日, 住所, 連絡先 | 申込時の情報の組 |
| 被保険者情報 (InsuredPersonInfo) | 氏名, 生年月日, 性別, 喫煙の有無 | 保険料計算に必要な情報 |
| 受取人情報 (BeneficiaryInfo) | 氏名, 続柄, 受取割合 | 受取人の一行 |
| 告知事項 (HealthDeclaration) | 既往歴リスト, 現在の健康状態, 服薬情報 | 引受審査の入力 |
| 保障内容 (CoverageDetails) | 基本保障額, 選択した特約リスト, 各特約の保障額 | 契約の保障範囲 |
| 引受条件 (UnderwritingCondition) | 条件種別(不担保/保険料割増), 対象疾病, 不担保期間, 割増率 | 条件付き引受の内容 |
| 申込ステータス (ApplicationStatus) | 申込中/審査中/条件提示中/承諾/謝絶 | 列挙型 |
| 契約ステータス (PolicyStatus) | 契約中/失効/解約/満期 | 列挙型 |
| 入金ステータス (PaymentStatus) | 未請求/請求済み/入金確認/滞納 | 列挙型 |
| 請求ステータス (ClaimStatus) | 請求受付/査定中/支払決定/支払完了/免責 | 列挙型 |
| 査定結果 (AssessmentResult) | 全額支払い/減額支払い/免責 | 列挙型 |
| 金額 (Money) | 数値, 通貨 | 汎用値オブジェクト |
| 証券番号 (PolicyNumber) | 文字列（フォーマットルール付き） | 一意識別の値 |

#### 集約と境界の理由

| 集約ルート | 含まれるもの | 境界の理由・注意点 |
|---|---|---|
| **InsuranceProduct** | InsuranceProduct + 特約定義 | 商品マスタ。全契約から参照される。変更頻度は低い |
| **PremiumRateTable** | PremiumRateTable 単体 | 料率テーブルは商品に紐づくが、独立して管理・更新される。版管理（有効期間付き）が必要 |
| **Application** | Application + HealthDeclaration | 申込と告知は一体で提出。審査の入力となる |
| **UnderwritingReview** | UnderwritingReview + UnderwritingCondition | 審査は申込に対して行われるが、独立したプロセス。条件付き引受の条件はここで管理 |
| **Policy** | Policy + CoverageDetails + BeneficiaryInfo リスト | 契約の核心。保障内容と受取人は契約と一体。**これが最も重要な集約。** 契約内容の変更（保障額変更、特約追加、受取人変更）は Policy 集約内で行う |
| **PremiumBilling** | PremiumBilling 単体 | 保険料請求は月次/年次で発生。個別に入金管理。契約集約に含めると肥大化 |
| **Claim** | Claim 単体 | 保険金請求は独立したライフサイクル。1契約に対して複数の請求がありうる |
| **ClaimAssessment** | ClaimAssessment 単体 | 査定は請求に対して行われるが、査定プロセスとして独立。査定の差し戻し・再査定もある |

#### ドメインイベント

- `ApplicationSubmitted` — 申込が提出された
- `UnderwritingCompleted` — 引受審査が完了した
- `ConditionalOfferPresented` — 条件付き引受が提示された
- `ConditionalOfferAccepted` — 条件付き引受が承諾された
- `ApplicationDeclined` — 申込が謝絶された
- `InitialPremiumPaid` — 初回保険料が入金された（→ 契約成立トリガー）
- `PolicyIssued` — 契約が成立、証券番号が発行された
- `PremiumBilled` — 保険料が請求された
- `PremiumPaid` — 保険料が入金された
- `PremiumOverdue` — 保険料が滞納された
- `PolicyLapsed` — 契約が失効した（2ヶ月滞納）
- `PolicyReinstated` — 契約が復活した
- `PolicySurrendered` — 契約が解約された（→ 返戻金支払い）
- `PolicyMatured` — 契約が満期を迎えた
- `CoverageChanged` — 保障内容が変更された
- `BeneficiaryChanged` — 受取人が変更された
- `ClaimFiled` — 保険金が請求された
- `ClaimAssessed` — 査定が完了した
- `ClaimPaid` — 保険金が支払われた
- `ClaimDenied` — 保険金が免責（不支払い）となった

#### ドメインサービス

| サービス | 責務 |
|---|---|
| **保険料算出サービス (PremiumCalculationService)** | 被保険者の属性（年齢、性別、喫煙）と保障内容を PremiumRateTable に照合し、月額/年額保険料を算出する。条件付き引受の割増率も適用する |
| **引受判定サービス (UnderwritingDecisionService)** | 告知事項に基づいて引受可否を判定する。標準引受/条件付き/謝絶の振り分け。告知内容と商品の引受基準を照合 |
| **失効・復活管理サービス (PolicyLapseService)** | 滞納期間を監視し、2ヶ月経過で失効処理。復活時は未払い保険料の精算と再告知の検証を行う |
| **解約返戻金計算サービス (SurrenderValueCalculator)** | 契約年数、払込保険料総額、商品の返戻率テーブルに基づいて解約返戻金を算出。ポリシーとして分離 |
| **保険金査定サービス (ClaimAdjudicationService)** | 保険金請求に対して、保障内容との照合（対象の事故か）、免責事由の確認（免責期間内か）、告知義務違反の調査を行い、支払額を決定する。Policy（保障内容）と Claim（請求内容）を横断参照 |

#### 設計判断の解説

**1. 引受審査のフロー**

```
申込 (ApplicationSubmitted)
  → 告知事項の確認
  → UnderwritingDecisionService
      ├── 標準引受 → UnderwritingCompleted(標準)
      │     → 初回保険料の請求
      ├── 条件付き → ConditionalOfferPresented
      │     → 契約者の承諾待ち
      │     ├── 承諾 → ConditionalOfferAccepted → 初回保険料の請求
      │     └── 拒否 → 申込終了
      └── 謝絶 → ApplicationDeclined
  
初回保険料入金 (InitialPremiumPaid)
  → PolicyIssued（契約成立）
```

- Application と UnderwritingReview を分離する理由: 審査は申込に対する「判定プロセス」であり、申込自体とはライフサイクルが異なる。将来的に自動審査・AI審査など審査ロジックが複雑化した場合も、分離されていれば影響範囲を限定できる

**2. 契約の失効と復活**

```
保険料滞納 (PremiumOverdue)
  → 1ヶ月目: 猶予期間（督促通知）
  → 2ヶ月目: PolicyLapsed（失効）

復活申請（失効から3年以内）:
  → 未払い保険料の精算
  → 健康状態の再告知 → UnderwritingDecisionService で再審査
  → 審査通過 + 未払い精算完了 → PolicyReinstated
```

- 失効は契約ステータスの変更であり、Policy 集約内で管理
- 復活は再審査を伴うため、UnderwritingReview を新たに作成する
- 失効中も契約データは保持される（3年間）。ステータスが「失効」になるだけ

**3. 保険金請求の査定プロセス**

```
保険事故発生 → ClaimFiled
  → ClaimAdjudicationService
      1. 保障内容との照合: この事故は保障対象か？
      2. 免責事由の確認: 免責期間内か？自殺免責か？
      3. 告知義務違反: 告知事項に虚偽はないか？
      4. 条件付き引受の確認: 不担保疾病に該当しないか？
  → ClaimAssessed
      ├── 全額支払い → ClaimPaid
      ├── 減額支払い → ClaimPaid（減額理由付き）
      └── 免責 → ClaimDenied（免責理由付き）
```

- Claim と ClaimAssessment を分離する理由: 請求の受付（書類の収集・管理）と査定（判定ロジック）は異なる関心事。査定に時間がかかる場合や、異議申立による再査定もありうる
- 査定ロジック（ClaimAdjudicationService）は Policy の保障内容・引受条件・告知事項を広範に参照する。これはドメインの中でも最も複雑なビジネスルールの1つであり、ポリシーパターンやルールエンジンの導入も検討される領域
