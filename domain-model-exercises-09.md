# ドメインモデル抽出 — 練習問題と模範解答（第9回）

---

## 【問題 1】初級 — スポーツジム会員管理

### 要件

> スポーツジムの会員管理システムを設計してください。
>
> - 会員はプラン（月額/年額）を選んで入会する。プランにはプラン名、料金、利用可能時間帯（全日/平日のみ/夜間のみ）がある。
> - 会員には会員番号が付与される。入会時に氏名、生年月日、電話番号、緊急連絡先を登録する。
> - 会員はジムに入館する際にICカードをかざしてチェックインする。チェックアウトは退館時に行う。
> - プランの利用可能時間帯外にはチェックインできない。
> - 会員はオプションサービス（パーソナルトレーニング、ロッカー、タオルレンタル等）を追加契約できる。各オプションには月額料金がある。
> - 月額料金（プラン料金 + オプション料金の合計）が毎月自動引き落としされる。
> - 会員は休会できる（最大3ヶ月）。休会中は月額料金が発生せず、チェックインもできない。
> - 退会時は当月末で退会となる。

**問い**: エンティティ、値オブジェクト、集約、ドメインイベントを抽出してください。

---

### 模範解答 1

#### エンティティ

| エンティティ | 識別子 | 主な属性・関連 |
|---|---|---|
| 会員 (Member) | memberId (会員番号) | 氏名, 生年月日, 電話番号, 緊急連絡先, プラン, オプションリスト, 会員ステータス |
| プラン (Plan) | planId | プラン名, 料金, 利用可能時間帯 |
| チェックイン記録 (CheckInRecord) | recordId | 会員, チェックイン日時, チェックアウト日時 |
| 月次請求 (MonthlyBilling) | billingId | 会員, 対象年月, プラン料金, オプション料金, 合計金額, 入金ステータス |

#### 値オブジェクト

| 値オブジェクト | 構成要素 | 理由 |
|---|---|---|
| 利用可能時間帯 (AccessWindow) | 全日/平日のみ/夜間のみ + 具体的な時間範囲 | プランの制約ルール |
| 会員ステータス (MemberStatus) | アクティブ/休会中/退会予約/退会済み | 列挙型 |
| オプション契約 (OptionContract) | オプション名, 月額料金, 開始日 | 会員に付随する契約の一行 |
| 緊急連絡先 (EmergencyContact) | 氏名, 電話番号, 続柄 | 属性の組 |
| 金額 (Money) | 数値, 通貨 | 汎用値オブジェクト |
| 入金ステータス (PaymentStatus) | 未請求/請求済み/入金済み/滞納 | 列挙型 |
| 休会期間 (SuspensionPeriod) | 開始日, 終了日 | 期間の値 |

#### 集約

| 集約ルート | 含まれるもの | 整合性のルール |
|---|---|---|
| **Member** | Member + OptionContract リスト | 会員の状態管理（プラン、オプション、ステータス）は一体。オプション数は通常数件で肥大化リスクなし |
| **Plan** | Plan 単体 | プランマスタ |
| **CheckInRecord** | CheckInRecord 単体 | チェックイン記録は高頻度で発生。独立管理 |
| **MonthlyBilling** | MonthlyBilling 単体 | 月次請求は独立したライフサイクル |

#### ドメインイベント

- `MemberJoined` — 入会した
- `MemberCheckedIn` — チェックインした
- `MemberCheckedOut` — チェックアウトした
- `CheckInDenied` — チェックインが拒否された（時間帯外 or 休会中）
- `OptionAdded` — オプションが追加された
- `OptionRemoved` — オプションが解約された
- `MembershipSuspended` — 休会が開始された
- `MembershipResumed` — 休会が終了した
- `MembershipCancelled` — 退会が予約された
- `MonthlyBillingGenerated` — 月次請求が生成された

#### 解説ポイント

- **チェックイン時のバリデーション**: 会員ステータス（アクティブか）とプランの利用可能時間帯（現在時刻が範囲内か）の2つを確認する。これは Member 集約と Plan 集約をまたぐ参照。ドメインサービス（チェックイン許可サービス）として切り出すか、Member がプランへの参照を持って自身で判定するか。
- **休会の最大3ヶ月制限**: 休会開始時に SuspensionPeriod を設定し、3ヶ月を超える期間は拒否する。Member 集約内のルール。

---

## 【問題 2】中級 — 電子処方箋・薬局システム

### 要件

> 電子処方箋と薬局の調剤管理システムを設計してください。
>
> - 医師は診察後に電子処方箋を発行する。処方箋には患者情報、処方薬リスト（薬品名、用量、用法、日数）、発行日、有効期限（発行日から4日間）がある。
> - 処方箋は中央サーバーに登録され、患者に処方箋IDが通知される。
> - 患者は任意の薬局に処方箋IDを提示して調剤を依頼する。
> - 薬剤師は処方箋の内容を確認し、調剤を行う。調剤時に以下をチェックする:
>   - 処方箋の有効期限が切れていないか
>   - 患者のお薬手帳（過去の調剤履歴）と照合して、飲み合わせ（相互作用）に問題がないか
>   - 同一処方箋で二重調剤されていないか
> - 問題がなければ調剤が確定し、患者に薬が渡される。
> - 調剤時にジェネリック医薬品への変更が可能。変更には患者の同意と医師への通知が必要。
> - 調剤内容は「お薬手帳」に記録される。お薬手帳は患者ごとに1つあり、全薬局の調剤記録が集約される。
> - 薬局は在庫を管理しており、在庫不足の場合は一部の薬品を「分割調剤」として後日渡すことができる。分割調剤の残りの受取期限は処方箋の有効期限とは別に管理される。
> - 調剤報酬は調剤内容に基づいて計算され、保険適用後の患者負担額が算出される。

**問い**: エンティティ、値オブジェクト、集約（境界の理由も）、ドメインイベント、ドメインサービスを抽出してください。

---

### 模範解答 2

#### エンティティ

| エンティティ | 識別子 | 主な属性・関連 |
|---|---|---|
| 医師 (Doctor) | doctorId | 氏名, 医療機関, 医師免許番号 |
| 患者 (Patient) | patientId | 氏名, 生年月日, 保険証情報 |
| 処方箋 (Prescription) | prescriptionId | 医師, 患者, 処方薬リスト, 発行日, 有効期限, 調剤ステータス |
| 薬局 (Pharmacy) | pharmacyId | 薬局名, 所在地 |
| 調剤記録 (Dispensing) | dispensingId | 処方箋, 薬局, 薬剤師, 調剤日, 調剤明細リスト, 分割調剤フラグ |
| お薬手帳 (MedicationHistory) | historyId (= patientId) | 患者, 調剤記録リスト(への参照) |
| 薬品在庫 (DrugInventory) | inventoryId | 薬局, 薬品, 在庫数 |

#### 値オブジェクト

| 値オブジェクト | 構成要素 | 理由 |
|---|---|---|
| 処方薬 (PrescribedDrug) | 薬品名, 用量, 用法, 日数 | 処方の一行 |
| 調剤明細 (DispensingLine) | 薬品名, 調剤量, ジェネリック変更フラグ, 変更元薬品名 | 調剤の一行 |
| 保険証情報 (InsuranceInfo) | 保険者番号, 記号, 番号, 負担割合 | 属性の組 |
| 調剤ステータス (PrescriptionStatus) | 未調剤/調剤中/調剤完了/分割調剤中/期限切れ | 列挙型 |
| 薬品相互作用 (DrugInteraction) | 薬品A, 薬品B, 重篤度, 注意事項 | 飲み合わせの判定データ |
| 金額 (Money) | 数値, 通貨 | 汎用値オブジェクト |
| 分割調剤情報 (PartialDispensingInfo) | 未渡し薬品リスト, 受取期限 | 分割調剤の残りの管理 |

#### 集約と境界の理由

| 集約ルート | 含まれるもの | 境界の理由 |
|---|---|---|
| **Prescription** | Prescription + PrescribedDrug リスト | 処方箋と処方内容は一体で発行される。有効期限管理、二重調剤防止（調剤ステータス管理）はここ |
| **Dispensing** | Dispensing + DispensingLine + PartialDispensingInfo | 調剤記録と明細は一体。分割調剤の残り管理もここ |
| **MedicationHistory** | MedicationHistory 単体 | お薬手帳は調剤記録への参照を保持。調剤完了時にエントリが追加される。**注意**: 実際の調剤データは Dispensing 集約にあり、MedicationHistory は参照リストのみ持つ（軽量に保つ） |
| **DrugInventory** | DrugInventory 単体 | 在庫は薬局×薬品の単位で独立管理。調剤時に減算 |
| **Patient** | Patient + InsuranceInfo | 患者基本情報 |
| **Doctor** | Doctor 単体 | 医師情報 |
| **Pharmacy** | Pharmacy 単体 | 薬局情報 |

#### ドメインイベント

- `PrescriptionIssued` — 処方箋が発行された
- `DispensingRequested` — 調剤が依頼された
- `DispensingCompleted` — 調剤が完了した（→ お薬手帳に記録追加）
- `PartialDispensingCreated` — 分割調剤が発生した
- `RemainingDrugsDispensed` — 分割調剤の残りが渡された
- `GenericSubstitutionApplied` — ジェネリック変更が適用された（→ 医師への通知）
- `DrugInteractionDetected` — 飲み合わせの問題が検出された
- `PrescriptionExpired` — 処方箋が期限切れになった
- `DuplicateDispensingBlocked` — 二重調剤がブロックされた

#### ドメインサービス

| サービス | 責務 |
|---|---|
| **調剤チェックサービス (DispensingValidationService)** | 調剤前の全チェックを実行: ①処方箋の有効期限確認（Prescription集約）、②二重調剤チェック（Prescription のステータス）、③飲み合わせチェック（MedicationHistory の過去の調剤薬品と新処方薬品を照合）。複数集約を横断。 |
| **飲み合わせチェックサービス (DrugInteractionChecker)** | 薬品の組み合わせに対して相互作用データベースを参照し、問題を検出する。外部の薬品マスタ/相互作用データとの連携。 |
| **調剤報酬計算サービス (DispensingFeeCalculator)** | 調剤内容に基づいて調剤報酬を計算し、保険負担割合を適用して患者負担額を算出する。 |
| **在庫引当サービス (InventoryAllocationService)** | 調剤時に必要な薬品の在庫を確認し、引き当てる。在庫不足の場合に分割調剤を判定する。DrugInventory 集約を参照・更新。 |

#### 解説ポイント

- **処方箋の二重調剤防止**: Prescription 集約の調剤ステータスで管理。「未調剤」の処方箋のみ調剤可能。これは強い整合性が必要な不変条件であり、楽観ロック or 悲観ロックで保護する。
- **お薬手帳の設計**: 全薬局の調剤記録を集約するが、お薬手帳自体に調剤の詳細データをコピーすると肥大化する。調剤記録への参照（dispensingId）のリストを保持し、詳細は Dispensing 集約を参照する設計が適切。
- **ジェネリック変更の通知**: 変更が発生した場合、`GenericSubstitutionApplied` イベントを発行し、処方元の医師に非同期で通知する。調剤プロセスをブロックしない。

---

## 【問題 3】上級 — 物流配車・配送最適化システム

### 要件

> 物流会社の配車・配送管理システムを設計してください。
>
> **配送依頼**
> - 荷主から配送依頼を受け付ける。依頼には集荷先住所、配送先住所、荷物情報（重量、サイズ、個数、品目）、希望集荷日時、希望配達日時（時間帯指定あり）、温度帯（常温/冷蔵/冷凍）がある。
> - 配送依頼のステータスは「受付」→「配車済み」→「集荷済み」→「輸送中」→「配達完了」と遷移する。
>
> **車両・ドライバー管理**
> - 車両には車両番号、車種（軽トラ/2t/4t/10t）、最大積載量、温度帯対応（常温のみ/冷蔵対応/冷凍対応）がある。
> - ドライバーには氏名、保有免許種別、稼働可能時間帯がある。ドライバーの連続運転時間は4時間以内で、30分の休憩を挟む必要がある（法令遵守）。
> - 車両とドライバーの組み合わせが「配車」となる。ドライバーの免許種別が車両の車種に対応している必要がある。
>
> **配車計画**
> - 配送依頼を車両に割り当てる（配車）。1台の車両に複数の配送依頼をまとめて割り当てられる。
> - 配車計画では以下を最適化する:
>   - 車両の積載率（重量・サイズの制約内で最大化）
>   - 配送ルート（配達先の順序を最適化して総走行距離を最小化）
>   - 時間帯指定の遵守
>   - 温度帯の整合（冷凍品は冷凍車でのみ輸送可能）
> - 配車計画は日次で作成され、当日の配送分をまとめる。計画確定後も、緊急の追加依頼や変更に対応できる。
>
> **追跡・完了**
> - 配送中の車両の現在地がリアルタイムで追跡される（GPSデータ）。
> - ドライバーは各配送先での集荷完了・配達完了をアプリで記録する。受取人の電子サイン、不在時の対応（再配達/置き配/持ち戻り）も記録される。
> - 配達完了後、荷主に完了通知が送られる。配送実績（実際のルート、所要時間、燃料消費量）が記録される。

**問い**: エンティティ、値オブジェクト、集約（境界の理由と注意点）、ドメインイベント、ドメインサービスを抽出してください。特に「配車計画の作成と変更」「法令遵守（連続運転時間制限）の管理」「リアルタイム追跡と実績記録」の設計判断を説明してください。

---

### 模範解答 3

#### エンティティ

| エンティティ | 識別子 | 主な属性・関連 |
|---|---|---|
| 荷主 (Shipper) | shipperId | 企業名, 連絡先 |
| 配送依頼 (DeliveryRequest) | requestId | 荷主, 集荷先, 配送先, 荷物情報, 希望集荷日時, 希望配達時間帯, 温度帯, ステータス |
| 車両 (Vehicle) | vehicleId | 車両番号, 車種, 最大積載量, 温度帯対応 |
| ドライバー (Driver) | driverId | 氏名, 免許種別, 稼働可能時間帯 |
| 配車計画 (DispatchPlan) | planId | 対象日, 配車割当リスト, ステータス |
| 配車割当 (VehicleAssignment) | assignmentId | 車両, ドライバー, 配送依頼リスト(順序付き), 計画ルート |
| 配達記録 (DeliveryRecord) | recordId | 配送依頼, 完了種別, 完了日時, 電子サイン, 不在対応 |
| 車両位置情報 (VehicleLocation) | locationId | 車両, 緯度経度, 記録日時 |

#### 値オブジェクト

| 値オブジェクト | 構成要素 | 理由 |
|---|---|---|
| 住所 (Address) | 郵便番号, 都道府県, 市区町村, 番地, 建物名 | 属性の組で等価 |
| 荷物情報 (CargoInfo) | 重量, サイズ(縦×横×高さ), 個数, 品目 | 荷物の仕様 |
| 温度帯 (TemperatureZone) | 常温/冷蔵/冷凍 | 列挙型 |
| 車種 (VehicleType) | 軽トラ/2t/4t/10t | 列挙型 |
| 免許種別 (LicenseClass) | 普通/中型/大型 | 列挙型 |
| 配達時間帯 (DeliveryTimeSlot) | 午前/12-14時/14-16時/16-18時/18-20時 等 | 列挙型 |
| 配送ステータス (DeliveryStatus) | 受付/配車済み/集荷済み/輸送中/配達完了/不在持戻り | 列挙型 |
| 計画ステータス (PlanStatus) | 作成中/確定/実行中/完了 | 列挙型 |
| ルート (Route) | 配達先の順序リスト, 推定走行距離, 推定所要時間 | 最適化されたルート |
| 完了種別 (CompletionType) | 配達完了/不在再配達/置き配/持ち戻り | 列挙型 |
| 配送実績 (DeliveryPerformance) | 実際のルート, 所要時間, 燃料消費量 | 実績データの組 |
| 運転時間制限 (DrivingTimeConstraint) | 最大連続運転時間(4h), 必要休憩時間(30min) | 法令の値 |

#### 集約と境界の理由

| 集約ルート | 含まれるもの | 境界の理由・注意点 |
|---|---|---|
| **DeliveryRequest** | DeliveryRequest + CargoInfo | 配送依頼はそれぞれ独立したライフサイクル。個別にステータスが遷移する |
| **Vehicle** | Vehicle 単体 | 車両のマスタ情報 |
| **Driver** | Driver 単体 | ドライバー情報。稼働管理 |
| **DispatchPlan** | DispatchPlan + VehicleAssignment + ルート | 配車計画と車両割当は一体で作成・確定される。「どの車両にどの依頼をどの順序で」は計画全体の整合性として管理。**注意**: 大規模な計画（数十台×数百依頼）では VehicleAssignment を別集約に分離し、計画全体はSagaで管理する選択肢もある |
| **DeliveryRecord** | DeliveryRecord 単体 | 配達の完了記録。配送依頼とは参照関係。完了後は不変 |
| **VehicleLocation** | VehicleLocation 単体 | GPS位置情報は超高頻度で発生する追記のみのデータ。完全に独立 |
| **Shipper** | Shipper 単体 | 荷主情報 |

#### ドメインイベント

- `DeliveryRequestReceived` — 配送依頼が受け付けられた
- `DispatchPlanCreated` — 配車計画が作成された
- `DispatchPlanFinalized` — 配車計画が確定された
- `DispatchPlanModified` — 配車計画が変更された（緊急追加等）
- `PickupCompleted` — 集荷が完了した
- `InTransit` — 輸送が開始された
- `DeliveryCompleted` — 配達が完了した（→ 荷主への完了通知）
- `DeliveryFailed` — 配達が失敗した（不在等）
- `RedeliveryScheduled` — 再配達が予定された
- `VehicleLocationUpdated` — 車両位置が更新された
- `DriverRestRequired` — 連続運転時間が上限に近づいた（→ 休憩アラート）
- `DailyPerformanceRecorded` — 配送実績が記録された

#### ドメインサービス

| サービス | 責務 |
|---|---|
| **配車最適化サービス (DispatchOptimizationService)** | 配送依頼群を車両に割り当てる最適化ロジック。積載量制約、温度帯整合、時間帯指定、免許種別の適合を満たしつつ、総走行距離を最小化する。NP困難な組み合わせ最適化問題であり、ヒューリスティック/メタヒューリスティック手法を使用 |
| **ルート最適化サービス (RouteOptimizationService)** | 1台の車両に割り当てられた配送先群の訪問順序を最適化する（巡回セールスマン問題の変種）。時間帯指定を制約として考慮 |
| **運転時間管理サービス (DrivingTimeComplianceService)** | ドライバーの連続運転時間を追跡し、4時間到達前に休憩を挿入するようルートに休憩ポイントを組み込む。リアルタイムの運転状況（VehicleLocation の時系列データ）から算出 |
| **配車計画変更サービス (DispatchPlanModificationService)** | 確定済みの計画に対して、緊急の追加依頼や変更を反映する。既存の割当を崩さず、追加依頼を最適な車両に挿入する。部分的な再最適化 |
| **配送完了処理サービス (DeliveryCompletionService)** | 配達完了の記録、配送依頼のステータス更新、荷主への通知をオーケストレーションする。DeliveryRecord と DeliveryRequest をまたぐ |

#### 設計判断の解説

**1. 配車計画の作成と変更**

```
前日夜間バッチ:
  翌日の DeliveryRequest を収集
  → DispatchOptimizationService
      → 車両割当の最適化（積載量・温度帯・時間帯制約）
      → 各車両のルート最適化（訪問順序）
      → 休憩ポイントの挿入（法令遵守）
  → DispatchPlan 作成 → レビュー → 確定

当日の変更:
  緊急依頼追加 or キャンセル
  → DispatchPlanModificationService
      → 影響範囲の特定（どの車両の割当が変わるか）
      → 部分的な再最適化（全体再計算ではなく差分更新）
  → DispatchPlanModified
```

- 配車計画は DispatchPlan 集約内で一貫して管理。計画確定後の変更も同じ集約を更新する
- 大規模な変更（大量キャンセル等）の場合は計画を再作成する方が適切な場合もある

**2. 法令遵守（連続運転時間制限）の管理**

```
計画段階:
  ルート最適化時に、推定運転時間が4時間を超える区間に休憩ポイントを自動挿入
  → DrivingTimeConstraint を参照

実行段階:
  VehicleLocation の時系列から実際の運転時間を算出
  → 3.5時間経過 → DriverRestRequired（事前警告）
  → 4時間到達 → 強制休憩アラート
```

- 計画段階と実行段階の両方で管理する。計画はあくまで推定であり、渋滞等で実際の運転時間はずれる
- DrivingTimeComplianceService はリアルタイムで動作し、GPS データから運転状態（走行中/停車中）を判定

**3. リアルタイム追跡と実績記録**

```
リアルタイム層:
  車両GPS → VehicleLocationUpdated（数秒〜数十秒間隔）
  → 地図表示（現在地の可視化）
  → ETA（到着予測時刻）の更新
  → 運転時間の累積

実績記録:
  配達完了時 → DeliveryRecord 作成
  日次終了時 → DailyPerformanceRecorded
    → 実際のルート（VehicleLocation の軌跡から生成）
    → 所要時間、燃料消費量の記録
```

- VehicleLocation は超高頻度データ（1台あたり数秒間隔）。時系列データベース（InfluxDB等）での管理が実用的
- DeliveryRecord は配達単位の確定データ。VehicleLocation とは粒度が異なる
- 実績データ（DeliveryPerformance）は日次で VehicleLocation を集約して生成。将来の配車最適化の精度向上に活用
