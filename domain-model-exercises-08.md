# ドメインモデル抽出 — 練習問題と模範解答（第8回）

---

## 【問題 1】初級 — 駐車場管理システム

### 要件

> コインパーキングの管理システムを設計してください。
>
> - 駐車場には複数の駐車スペースがあり、各スペースには番号とサイズ（軽自動車用/普通車用/大型車用）がある。
> - 利用者は入庫時にナンバープレートが自動認識され、空きスペースに案内される。
> - 駐車料金は時間帯によって異なる（昼間: 30分200円、夜間: 60分100円）。最大料金の設定がある（24時間最大1500円）。
> - 利用者は出庫時に精算する。精算方法は現金、クレジットカード、電子マネーがある。
> - 月極契約もある。月極利用者は専用スペースが割り当てられ、月額固定料金を支払う。
> - 満車・空車の状況がリアルタイムで表示される。

**問い**: エンティティ、値オブジェクト、集約、ドメインイベントを抽出してください。

---

### 模範解答 1

#### エンティティ

| エンティティ | 識別子 | 主な属性・関連 |
|---|---|---|
| 駐車場 (ParkingLot) | lotId | 駐車場名, 所在地, 料金体系 |
| 駐車スペース (ParkingSpace) | spaceId | スペース番号, サイズ, ステータス, 月極契約者(nullable) |
| 駐車セッション (ParkingSession) | sessionId | 駐車スペース, ナンバープレート, 入庫時刻, 出庫時刻, 料金, 精算ステータス |
| 月極契約 (MonthlyContract) | contractId | 契約者, 駐車スペース, 月額料金, 契約期間 |

#### 値オブジェクト

| 値オブジェクト | 構成要素 | 理由 |
|---|---|---|
| ナンバープレート (LicensePlate) | プレート番号 | 識別用の値 |
| スペースサイズ (SpaceSize) | 軽自動車用/普通車用/大型車用 | 列挙型 |
| スペースステータス (SpaceStatus) | 空き/使用中/月極専用/故障中 | 列挙型 |
| 料金体系 (PricingPolicy) | 昼間料率, 夜間料率, 最大料金, 時間帯区分 | 料金計算のルール |
| 精算方法 (PaymentMethod) | 現金/クレジットカード/電子マネー | 列挙型 |
| 金額 (Money) | 数値, 通貨 | 汎用値オブジェクト |

#### 集約

| 集約ルート | 含まれるもの | 整合性のルール |
|---|---|---|
| **ParkingLot** | ParkingLot + ParkingSpace + PricingPolicy | 駐車場と駐車スペースは一体。空き状況の集計はこの集約内で可能。**注意**: スペース数が数百を超える大規模駐車場では ParkingSpace を別集約に分離する選択肢もある |
| **ParkingSession** | ParkingSession 単体 | 駐車の入庫〜出庫〜精算のライフサイクル |
| **MonthlyContract** | MonthlyContract 単体 | 月極契約は独立したライフサイクル |

#### ドメインイベント

- `VehicleEntered` — 車両が入庫した（→ スペースを「使用中」に変更）
- `VehicleExited` — 車両が出庫した
- `ParkingFeeCalculated` — 駐車料金が計算された
- `PaymentCompleted` — 精算が完了した（→ スペースを「空き」に変更）
- `LotFullStatusChanged` — 満車/空車状態が変化した

#### 解説ポイント

- **料金計算のロジック**: 入庫時刻〜出庫時刻の間で、昼間帯と夜間帯をまたぐ場合は時間帯ごとに料金を計算し合算する。最大料金との比較も必要。PricingPolicy を値オブジェクトにして計算ロジックを持たせるのが自然。
- **ParkingSession を ParkingLot に含めない理由**: セッションは頻繁に作成・更新される。駐車場集約に含めると、入出庫のたびに大きな集約をロックすることになる。

---

## 【問題 2】中級 — 社内研修管理システム

### 要件

> 企業の社内研修管理システムを設計してください。
>
> - 研修管理者は研修コースを作成する。コースにはタイトル、説明、カテゴリ（技術/マネジメント/コンプライアンス等）、対象者レベル（新人/中堅/管理職）がある。
> - コースには「必須研修」と「選択研修」がある。必須研修は対象の社員全員が受講義務を持つ。
> - 研修は「集合研修」と「eラーニング」の2形態がある。
>   - 集合研修: 日時、会場、定員、講師が設定される。
>   - eラーニング: 教材（動画/スライド/テスト）とコンテンツURLが設定される。受講期限がある。
> - 社員は選択研修に自分で申し込める。集合研修には定員があり、定員を超えるとキャンセル待ちになる。
> - 必須研修は対象社員に自動で受講指示が出される。対象の判定は部署・役職・入社年次などの条件に基づく。
> - 集合研修の出欠は講師が記録する。eラーニングは受講完了（動画の視聴完了+テストの合格）をシステムが自動判定する。
> - 社員ごとの受講履歴が管理される。必須研修の未受講者には期限前にリマインダーが送られる。
> - 部署ごとの研修受講率レポートが出力できる。

**問い**: エンティティ、値オブジェクト、集約（境界の理由も）、ドメインイベント、ドメインサービスを抽出してください。

---

### 模範解答 2

#### エンティティ

| エンティティ | 識別子 | 主な属性・関連 |
|---|---|---|
| 社員 (Employee) | employeeId | 氏名, 部署, 役職, 入社年次 |
| 研修コース (TrainingCourse) | courseId | タイトル, 説明, カテゴリ, 対象者レベル, 必須/選択, 研修形態 |
| 集合研修セッション (ClassroomSession) | sessionId | コース, 日時, 会場, 定員, 講師 |
| eラーニングコンテンツ (ELearningContent) | contentId | コース, 教材リスト, コンテンツURL, 受講期限 |
| 受講登録 (Enrollment) | enrollmentId | 社員, コース(またはセッション), 登録種別(自主/指示), 受講ステータス |
| 受講指示 (TrainingAssignment) | assignmentId | コース, 対象条件, 期限, 指示日 |

#### 値オブジェクト

| 値オブジェクト | 構成要素 | 理由 |
|---|---|---|
| 研修カテゴリ (TrainingCategory) | 技術/マネジメント/コンプライアンス等 | 列挙型 |
| 対象者レベル (TargetLevel) | 新人/中堅/管理職 | 列挙型 |
| 研修形態 (DeliveryFormat) | 集合研修/eラーニング | 列挙型 |
| 受講ステータス (EnrollmentStatus) | 登録済み/キャンセル待ち/受講中/完了/未完了/欠席 | 列挙型 |
| 会場 (Venue) | 会場名, 所在地, 収容人数 | 属性の組で等価 |
| 教材 (Material) | 教材種別(動画/スライド/テスト), タイトル, URL | コンテンツの一行 |
| 対象条件 (TargetCriteria) | 部署, 役職, 入社年次, その他条件 | 受講対象の判定ルール |
| 出欠記録 (AttendanceRecord) | 出席/欠席/遅刻, 記録日時 | 出欠の値 |

#### 集約と境界の理由

| 集約ルート | 含まれるもの | 境界の理由 |
|---|---|---|
| **Employee** | Employee 単体 | 社員の基本情報。組織情報（部署・役職）の管理 |
| **TrainingCourse** | TrainingCourse 単体 | コースの定義情報。形態に応じた詳細は別集約 |
| **ClassroomSession** | ClassroomSession 単体 | 集合研修の開催情報。定員管理はここ |
| **ELearningContent** | ELearningContent + Material リスト | eラーニングの教材構成は一体で管理 |
| **Enrollment** | Enrollment + AttendanceRecord(集合研修の場合) | 受講の記録とステータス管理。社員×コースの単位 |
| **TrainingAssignment** | TrainingAssignment + TargetCriteria | 受講指示と対象条件は一体 |

#### ドメインイベント

- `CourseCreated` — 研修コースが作成された
- `SessionScheduled` — 集合研修セッションが設定された
- `TrainingAssigned` — 必須研修の受講指示が出された（→ 対象社員への通知）
- `EnrollmentRequested` — 社員が選択研修に申し込んだ
- `EnrollmentConfirmed` — 受講登録が確定した
- `WaitlistAdded` — キャンセル待ちに追加された
- `WaitlistPromoted` — キャンセル待ちから繰り上げ確定した
- `AttendanceRecorded` — 出欠が記録された
- `ELearningCompleted` — eラーニングが受講完了した
- `ELearningTestPassed` — eラーニングのテストに合格した
- `TrainingDeadlineApproaching` — 必須研修の期限が迫っている（→ リマインダー送信）
- `TrainingOverdue` — 必須研修が未受講のまま期限を超過した

#### ドメインサービス

| サービス | 責務 |
|---|---|
| **受講対象判定サービス (TargetResolutionService)** | TrainingAssignment の対象条件（部署・役職・入社年次）に基づいて、対象社員のリストを抽出する。Employee の属性と TargetCriteria を照合。 |
| **定員管理サービス (CapacityManagementService)** | 集合研修の申込時に定員をチェックし、受講確定またはキャンセル待ちに振り分ける。キャンセル発生時に待機者を繰り上げる。ClassroomSession と Enrollment を横断。 |
| **eラーニング完了判定サービス (ELearningCompletionService)** | 動画の視聴状況とテストの合否を確認し、コースの受講完了を判定する。ELearningContent（教材構成）と Enrollment（進捗）を横断。 |
| **受講率集計サービス (TrainingComplianceService)** | 部署ごとの必須研修の受講率を集計する。Employee（部署）、TrainingAssignment（対象研修）、Enrollment（受講状況）を横断するクエリ。レポート用途。 |

#### 解説ポイント

- **TrainingCourse と ClassroomSession/ELearningContent の分離**: コース定義（何を学ぶか）と実施方法（いつどこで/どのコンテンツで）を分離する。同じコースの集合研修が複数回開催されるケース（第1回: 4月、第2回: 7月）に対応できる。
- **Enrollment を独立集約にする理由**: 受講登録は社員×コース（またはセッション）の組み合わせで個別に管理される。コース集約や社員集約に含めると、それぞれの集約が受講者数分の Enrollment を抱えて肥大化する。
- **必須研修の自動指示**: TrainingAssignment は「条件に合致する全社員」を対象にする宣言的な指示。個別の Enrollment は TargetResolutionService が社員を特定した後に生成する。対象条件は組織変更で変わりうるため、指示時点の条件をスナップショットとして保持する。

---

## 【問題 3】上級 — 広告配信プラットフォーム

### 要件

> オンライン広告の配信プラットフォームを設計してください。
>
> **広告主側**
> - 広告主はアカウントを作成し、予算を入金する。
> - 広告主はキャンペーンを作成する。キャンペーンには名前、期間（開始日〜終了日）、日予算（1日あたりの上限額）、総予算がある。
> - キャンペーン内に複数の広告グループを作成する。広告グループにはターゲティング条件（年齢層、性別、地域、興味関心カテゴリ）がある。
> - 広告グループ内に複数の広告クリエイティブを登録する。クリエイティブにはタイトル、説明文、画像/動画URL、リンク先URLがある。
> - クリエイティブは審査を経て配信可能になる。審査不合格の場合は理由が提示される。
>
> **配信・課金**
> - 配信方式はCPC（クリック課金）とCPM（インプレッション課金/1000回表示あたり）を選択できる。
> - 入札額（CPC: 1クリックあたりの入札額、CPM: 1000インプレッションあたりの入札額）を設定する。
> - 広告リクエストがあると、ターゲティング条件に合致する広告がオークションで選定される。最高入札額の広告が配信される（セカンドプライスオークション: 実際の課金額は2番目に高い入札額+1円）。
> - 日予算に達したキャンペーンはその日の配信が停止される。総予算に達したキャンペーンは終了する。
> - クリック・インプレッションのイベントがリアルタイムで記録される。
>
> **レポート**
> - 広告主はキャンペーン・広告グループ・クリエイティブ単位で、インプレッション数、クリック数、CTR（クリック率）、消化金額のレポートを確認できる。
> - レポートデータは日次で集計される。リアルタイムの概算値も表示される。
>
> **不正検知**
> - 同一ユーザーからの短時間連続クリック、ボットによる不正クリックを検知し、課金対象から除外する。除外されたクリックは「無効クリック」として記録される。

**問い**: エンティティ、値オブジェクト、集約（境界の理由と注意点）、ドメインイベント、ドメインサービスを抽出してください。特に「オークションによる広告選定」「予算消化の管理」「リアルタイムイベント処理とレポート集計」の設計判断を説明してください。

---

### 模範解答 3

#### エンティティ

| エンティティ | 識別子 | 主な属性・関連 |
|---|---|---|
| 広告主 (Advertiser) | advertiserId | 企業名, 残高 |
| キャンペーン (Campaign) | campaignId | 名前, 期間, 日予算, 総予算, 消化済み金額, ステータス, 広告主 |
| 広告グループ (AdGroup) | adGroupId | キャンペーン, ターゲティング条件, 入札額, 課金方式 |
| クリエイティブ (Creative) | creativeId | 広告グループ, タイトル, 説明文, 画像/動画URL, リンク先URL, 審査ステータス |
| 配信イベント (DeliveryEvent) | eventId | クリエイティブ, イベント種別(インプレッション/クリック), 日時, ユーザー情報, 課金額, 有効/無効フラグ |
| 日次レポート (DailyReport) | reportId | 集計対象(キャンペーン/AdGroup/クリエイティブ), 日付, インプレッション数, クリック数, 消化金額 |

#### 値オブジェクト

| 値オブジェクト | 構成要素 | 理由 |
|---|---|---|
| ターゲティング条件 (TargetingCriteria) | 年齢層, 性別, 地域, 興味関心カテゴリ | ターゲティングの組 |
| 課金方式 (BillingModel) | CPC/CPM | 列挙型 |
| 入札額 (BidAmount) | 金額, 課金方式 | 入札の値 |
| キャンペーンステータス (CampaignStatus) | 下書き/配信中/一時停止/日予算到達/終了 | 列挙型 |
| 審査ステータス (ReviewStatus) | 審査中/承認/不合格 | 列挙型 |
| 審査結果 (ReviewResult) | 合否, 不合格理由(nullable) | 審査の判定 |
| 金額 (Money) | 数値, 通貨 | 汎用値オブジェクト |
| CTR (ClickThroughRate) | 数値(百分率) | 算出値 |
| イベント種別 (EventType) | インプレッション/クリック | 列挙型 |

#### 集約と境界の理由

| 集約ルート | 含まれるもの | 境界の理由・注意点 |
|---|---|---|
| **Advertiser** | Advertiser 単体 | 広告主の残高管理。入金と消化の整合性 |
| **Campaign** | Campaign + AdGroup + Creative | キャンペーン→広告グループ→クリエイティブは階層構造であり、配信設定として一体で管理される。**注意**: 大規模キャンペーン（数百の AdGroup/Creative）では AdGroup を別集約に分離する選択肢がある。ただし日予算・総予算の管理はキャンペーン単位で行うため、Campaign は少なくとも予算情報を自己完結で持つ必要がある |
| **DeliveryEvent** | DeliveryEvent 単体 | 配信イベントは超高頻度で発生する。他の集約と完全に独立して書き込み性能を確保。イベントソーシング的な追記のみのデータ |
| **DailyReport** | DailyReport 単体 | レポートは集計結果。日次バッチで生成。他の集約とは独立 |

#### ドメインイベント

- `CampaignCreated` — キャンペーンが作成された
- `CampaignStarted` — キャンペーンの配信が開始された
- `CampaignPaused` — キャンペーンが一時停止された
- `CampaignEnded` — キャンペーンが終了した（期間満了 or 総予算消化）
- `CreativeSubmittedForReview` — クリエイティブが審査に提出された
- `CreativeApproved` — クリエイティブが審査承認された
- `CreativeRejected` — クリエイティブが審査不合格になった
- `AdImpressed` — 広告が表示された
- `AdClicked` — 広告がクリックされた
- `InvalidClickDetected` — 不正クリックが検知された
- `DailyBudgetReached` — 日予算に到達した（→ 当日の配信停止）
- `TotalBudgetReached` — 総予算に到達した（→ キャンペーン終了）
- `DailyReportGenerated` — 日次レポートが生成された

#### ドメインサービス

| サービス | 責務 |
|---|---|
| **広告オークションサービス (AdAuctionService)** | 広告リクエスト（ユーザー属性）を受け取り、ターゲティング条件に合致する広告グループをフィルタ。入札額でランキングし、セカンドプライスオークションで落札広告と課金額を決定する。**超低レイテンシ（数十ms以内）が求められる** |
| **予算消化管理サービス (BudgetTrackingService)** | 配信イベントの課金額をリアルタイムで集計し、日予算・総予算との比較を行う。到達時にキャンペーンの配信停止をトリガーする。**準リアルタイム集計が必要**（数分の遅延は許容されるが、大幅な超過は避ける） |
| **不正クリック検知サービス (FraudDetectionService)** | クリックイベントをリアルタイムで分析し、不正パターン（短時間連続クリック、ボット特徴）を検出する。不正と判定されたクリックを「無効」にマークし、課金対象から除外する |
| **日次レポート集計サービス (DailyReportAggregationService)** | DeliveryEvent を日次で集計し、各階層（キャンペーン/広告グループ/クリエイティブ）のレポートを生成する。有効イベントのみを集計対象とする |
| **クリエイティブ審査サービス (CreativeReviewService)** | クリエイティブの内容（画像・テキスト・リンク先）を審査基準に照合する。自動チェック（禁止ワード、画像ポリシー）+ 手動審査のフロー |

#### 設計判断の解説

**1. オークションによる広告選定**

```
広告リクエスト（ユーザー属性: 30代男性、東京、スポーツ好き）
  → フィルタリング:
      ターゲティング条件に合致する AdGroup を抽出
      + クリエイティブが審査承認済み
      + キャンペーンが配信中（日予算未到達）
  → ランキング:
      入札額の高い順にソート
  → セカンドプライスオークション:
      落札: 1位の広告
      課金額: 2位の入札額 + 1円（CPCの場合はクリック時に課金）
  → 配信
```

- オークションは**読み取り中心の超高速処理**。Campaign 集約の状態（配信中か）や残予算を参照するが、この時点では書き込みは発生しない
- 実装上はインメモリキャッシュに配信可能な広告リストを保持し、数十ms以内で応答する設計が一般的

**2. 予算消化の管理**

```
イベント発生 (AdClicked / AdImpressed)
  → DeliveryEvent 記録（超高速書き込み）
  → 非同期: BudgetTrackingService が集計
      → 日次消化額を準リアルタイムで更新
      → 日予算に近づいたらペーシング（配信速度調整）
      → 日予算到達 → DailyBudgetReached → 配信停止
      → 総予算到達 → TotalBudgetReached → キャンペーン終了
```

- 厳密なリアルタイム管理は困難（分散システムで完全な一貫性は高コスト）
- 実用的なアプローチ: 数分間隔で集計し、予算の95%到達でペーシング開始。多少の超過は許容し、超過分は広告主に請求しない（プラットフォーム負担）
- Campaign の「消化済み金額」は非正規化された値。DeliveryEvent の集計結果とは若干のラグがある

**3. リアルタイムイベント処理とレポート集計**

```
リアルタイム層:
  DeliveryEvent → ストリーム処理 → リアルタイムカウンタ（概算値）
                                   → 不正検知
                                   → 予算監視

バッチ層:
  DeliveryEvent → 日次バッチ → DailyReport（確定値）

表示:
  レポート画面 → 当日分: リアルタイムカウンタ（概算）
              → 過去分: DailyReport（確定）
```

- Lambda アーキテクチャ的な設計: リアルタイムの概算値とバッチの確定値を併用
- DeliveryEvent は追記のみ（イベントソーシング）。変更・削除されない
- 不正クリック除外はリアルタイム層で行い、DailyReport はフィルタリング後のデータで集計
