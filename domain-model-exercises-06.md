# ドメインモデル抽出 — 練習問題と模範解答（第6回）

---

## 【問題 1】初級 — 図書館蔵書管理システム

### 要件

> 公立図書館の蔵書管理・貸出システムを設計してください。
>
> - 利用者は図書館カードを発行して登録する。利用者情報には氏名、住所、電話番号、カード番号がある。
> - 蔵書には書誌情報（ISBN、タイトル、著者、出版社、出版年、ジャンル）がある。同じ書誌の本が複数冊ある（例: 同じISBNの本が3冊）。各冊には蔵書番号（バーコード）が振られている。
> - 利用者は最大5冊まで同時に借りられる。貸出期間は14日間。
> - 貸出中の本は他の利用者が予約（取り置き）できる。予約は1冊につき最大3名まで。返却時に予約者がいれば、先着順に通知される。
> - 返却期限を過ぎた場合、延滞として記録される。延滞中は新たな貸出ができない。
> - 利用者は貸出期限を1回だけ延長（14日間延長）できる。ただし、その本に予約が入っている場合は延長できない。

**問い**: エンティティ、値オブジェクト、集約、ドメインイベントを抽出してください。

---

### 模範解答 1

#### エンティティ

| エンティティ | 識別子 | 主な属性・関連 |
|---|---|---|
| 利用者 (Patron) | patronId (カード番号) | 氏名, 住所, 電話番号 |
| 書誌 (BookTitle) | isbn | タイトル, 著者, 出版社, 出版年, ジャンル |
| 蔵書 (BookCopy) | copyId (蔵書番号) | 書誌(への参照), ステータス |
| 貸出 (Loan) | loanId | 利用者, 蔵書, 貸出日, 返却期限, 返却日, 延長済みフラグ |
| 予約 (Hold) | holdId | 利用者, 書誌, 予約日時, ステータス |

#### 値オブジェクト

| 値オブジェクト | 構成要素 | 理由 |
|---|---|---|
| 蔵書ステータス (CopyStatus) | 利用可能/貸出中/予約取置中/修繕中 | 列挙型 |
| 貸出期間 (LoanPeriod) | 貸出日, 返却期限 | 期間を一体で扱う |
| 予約ステータス (HoldStatus) | 待機中/通知済み/完了/キャンセル | 列挙型 |
| 住所 (Address) | 郵便番号, 都道府県, 市区町村, 番地 | 属性の組で等価 |

#### 集約

| 集約ルート | 含まれるもの | 整合性のルール |
|---|---|---|
| **Patron** | Patron 単体 | 同時貸出5冊以内。延滞中は貸出不可 |
| **BookTitle** | BookTitle 単体 | 書誌マスタ情報の管理 |
| **BookCopy** | BookCopy 単体 | 蔵書のステータス管理 |
| **Loan** | Loan 単体 | 貸出の記録。延長は1回まで |
| **Hold** | Hold 単体 | 予約の管理。同一書誌に対する予約上限は横断チェック |

#### ドメインイベント

- `BookBorrowed` — 本が貸し出された（→ 蔵書ステータスを「貸出中」に変更）
- `BookReturned` — 本が返却された（→ 予約者への通知判定トリガー）
- `LoanExtended` — 貸出期限が延長された
- `LoanOverdue` — 返却期限を超過した（→ 利用者の延滞フラグ設定）
- `HoldPlaced` — 予約が登録された
- `HoldNotified` — 予約者に返却通知が送られた
- `HoldCancelled` — 予約がキャンセルされた

#### 解説ポイント

- **BookTitle と BookCopy を分ける理由**: 書誌情報（何の本か）と蔵書（物理的な1冊）は異なるライフサイクル。同じISBNの本が複数冊あり、貸出・返却は蔵書単位で行われる。
- **予約は書誌に対して行う**: 予約者は「この本が読みたい」のであり、特定の蔵書番号を指定するわけではない。返却された蔵書を予約者に割り当てるのはサービス層のロジック。
- **「同時貸出5冊以内」の不変条件**: 貸出作成時に、その利用者の現在の貸出数をチェックする必要がある。Patron 集約に Loan を含めるか、ドメインサービスで横断チェックするかは設計判断。Loan を独立集約にして横断チェックする方が、集約サイズを小さく保てる。

---

## 【問題 2】中級 — ポイント・クーポン管理システム

### 要件

> ECサイトのポイント・クーポン管理システムを設計してください。
>
> - 会員は購入金額の1%がポイントとして付与される。ポイントは1ポイント=1円として次回以降の購入で使える。
> - ポイントには有効期限がある。付与日から1年間有効で、期限を過ぎたポイントは失効する。
> - ポイントの使用は「先入れ先出し（FIFO）」で行われる。古いポイントから消費される。
> - キャンペーンで「ボーナスポイント」が付与されることがある。ボーナスポイントは通常ポイントとは有効期限が異なる場合がある（例: 30日間限定）。
> - クーポンは運営が発行する。クーポンには以下の種類がある:
>   - 割引クーポン: 金額指定（500円引き）またはパーセント指定（10%引き、上限額あり）
>   - 送料無料クーポン
> - クーポンには利用条件がある: 最低購入金額、対象カテゴリ、対象商品、利用可能期間。
> - クーポンには「全会員配布型」と「特定会員配布型」がある。全会員配布型は全会員が利用できるが、1人1回まで。特定会員配布型は指定された会員のみ利用可能。
> - 1回の注文で使えるクーポンは1枚まで。ポイントとクーポンは併用可能。
> - 注文がキャンセルされた場合、使用したポイントは返還される（元の有効期限で復活）。クーポンも未使用状態に戻る。

**問い**: エンティティ、値オブジェクト、集約（境界の理由も）、ドメインイベント、ドメインサービスを抽出してください。

---

### 模範解答 2

#### エンティティ

| エンティティ | 識別子 | 主な属性・関連 |
|---|---|---|
| 会員 (Member) | memberId | 氏名, メールアドレス |
| ポイント残高 (PointBalance) | balanceId (= memberId) | 会員, 総残高 |
| ポイントロット (PointLot) | lotId | 付与日, 有効期限, 付与量, 残量, 種別(通常/ボーナス), ポイント残高 |
| クーポン定義 (CouponDefinition) | couponDefId | クーポン名, 割引タイプ, 割引値, 上限額, 利用条件, 配布タイプ, 利用可能期間 |
| クーポン付与 (CouponGrant) | grantId | クーポン定義, 会員, 使用済みフラグ |

#### 値オブジェクト

| 値オブジェクト | 構成要素 | 理由 |
|---|---|---|
| 金額 (Money) | 数値, 通貨 | 汎用値オブジェクト |
| 割引タイプ (DiscountType) | 金額指定/パーセント指定/送料無料 | 列挙型 |
| 割引値 (DiscountValue) | 数値, タイプ(金額/パーセント), 上限額(nullable) | 割引内容を一体で表現 |
| 利用条件 (UsageCondition) | 最低購入金額, 対象カテゴリ, 対象商品, 利用可能期間 | クーポンの適用ルール |
| 配布タイプ (DistributionType) | 全会員/特定会員 | 列挙型 |
| ポイント種別 (PointType) | 通常/ボーナス | 列挙型 |
| ポイント使用明細 (PointUsageDetail) | ロットID, 消費量 | FIFO消費の追跡用 |

#### 集約と境界の理由

| 集約ルート | 含まれるもの | 境界の理由 |
|---|---|---|
| **Member** | Member 単体 | 会員基本情報の管理 |
| **PointBalance** | PointBalance + PointLot リスト | ポイントの残高管理は FIFO 消費のために全ロットの状態を把握する必要がある。ポイント付与・消費・失効は PointBalance 集約内で整合性を保つ。**注意**: ロット数が数百を超える場合は、失効済みロットをアーカイブして集約サイズを抑える。 |
| **CouponDefinition** | CouponDefinition 単体 | クーポンのマスタ定義。全会員から参照される。利用条件の変更はクーポン定義単位。 |
| **CouponGrant** | CouponGrant 単体 | 「誰にどのクーポンが付与されたか」の記録。使用済みフラグの管理。CouponDefinition とは参照関係。 |

#### ドメインイベント

- `PointsEarned` — ポイントが付与された（通常 or ボーナス）
- `PointsUsed` — ポイントが使用された（FIFO消費の明細付き）
- `PointsReturned` — キャンセルによりポイントが返還された
- `PointsExpired` — ポイントが失効した
- `CouponCreated` — クーポン定義が作成された
- `CouponGranted` — クーポンが会員に付与された
- `CouponUsed` — クーポンが使用された
- `CouponReturned` — キャンセルによりクーポンが未使用に戻った

#### ドメインサービス

| サービス | 責務 |
|---|---|
| **ポイント消費サービス (PointConsumptionService)** | 使用ポイント数を受け取り、PointBalance 集約内のロットを FIFO で消費する。どのロットからいくら消費したかの明細を返す。 |
| **クーポン適用判定サービス (CouponEligibilityService)** | 注文内容（商品リスト、合計金額）とクーポンの利用条件を照合し、クーポンが適用可能かを判定する。割引額を算出する。 |
| **ポイント失効バッチサービス (PointExpirationService)** | 日次バッチで全会員の期限切れロットを検出し、残量を失効させる。 |
| **注文キャンセル返還サービス (OrderCancellationRefundService)** | 注文キャンセル時に、使用されたポイント（元のロットに復活）とクーポン（未使用に戻す）を返還する。PointBalance 集約と CouponGrant 集約をまたぐ。 |

#### 解説ポイント

- **PointLot（ポイントロット）を導入する理由**: 有効期限の異なるポイントを混ぜて管理すると、FIFO消費や失効処理ができない。付与のたびにロットを作成し、残量を個別に管理する。
- **キャンセル時のポイント返還**: 元のロットに残量を戻す必要がある（元の有効期限で復活）。どのロットからいくら消費したかを注文時に記録しておく（PointUsageDetail）ことで、正確な返還が可能になる。
- **CouponDefinition と CouponGrant の分離**: 「全会員配布型」の場合、全会員分の CouponGrant を事前に作るのは非効率。CouponDefinition の配布タイプが「全会員」なら、利用時に CouponGrant を遅延生成する設計もある。

---

## 【問題 3】上級 — 不動産賃貸管理プラットフォーム

### 要件

> 不動産の賃貸管理プラットフォームを設計してください。
>
> **物件管理**
> - オーナー（大家）は物件を登録する。物件には物件名、所在地、築年数、構造（木造/RC/SRC等）がある。
> - 物件には複数の部屋（区画）がある。各部屋には部屋番号、間取り（1K/2LDK等）、面積（㎡）、階数、賃料、管理費、敷金・礼金がある。
> - 部屋のステータスは「空室」「入居中」「退去予定」「リフォーム中」がある。
>
> **募集・契約**
> - 空室の部屋は募集に出せる。募集情報には掲載写真、設備リスト、入居可能日、条件（ペット可否、楽器可否等）がある。
> - 入居希望者は内見予約を申し込む。内見は日時を指定し、物件担当者が対応する。
> - 入居希望者が申し込むと、入居審査が行われる。審査には勤務先、年収、連帯保証人の情報が必要。
> - 審査通過後、賃貸借契約が締結される。契約には契約期間（通常2年）、賃料、管理費、敷金・礼金、特約条件が含まれる。
> - 契約は「契約中」→「更新」または「解約予告」→「退去完了」と遷移する。更新時は更新料が発生する。
>
> **家賃管理**
> - 家賃は毎月、契約で定められた日に引き落とされる。家賃 = 賃料 + 管理費。
> - 入金が確認できない場合、3日後にリマインダー、7日後に督促通知、30日後に法的措置の警告が送られる。
> - 家賃の滞納履歴は入居者ごとに記録される。
>
> **退去・精算**
> - 入居者は退去の1ヶ月前までに解約予告を行う。
> - 退去時に原状回復の立会い検査が行われ、損傷箇所が記録される。
> - 敷金から原状回復費用を差し引いた残額が返還される。原状回復費用が敷金を超える場合は追加請求される。
> - 退去精算書が発行される。精算書には敷金、原状回復費用の内訳、返還額（または追加請求額）が記載される。

**問い**: エンティティ、値オブジェクト、集約（境界の理由と注意点）、ドメインイベント、ドメインサービスを抽出してください。特に「家賃滞納時のエスカレーション」「退去精算のフロー」の設計判断を説明してください。

---

### 模範解答 3

#### エンティティ

| エンティティ | 識別子 | 主な属性・関連 |
|---|---|---|
| オーナー (Owner) | ownerId | 氏名, 連絡先, 銀行口座情報 |
| 物件 (Property) | propertyId | 物件名, 所在地, 築年数, 構造, オーナー |
| 部屋 (Room) | roomId | 部屋番号, 間取り, 面積, 階数, 賃料, 管理費, 敷金, 礼金, ステータス |
| 募集 (Listing) | listingId | 部屋, 掲載写真, 設備リスト, 入居可能日, 条件 |
| 入居希望者 (Applicant) | applicantId | 氏名, 連絡先 |
| 内見予約 (ViewingAppointment) | appointmentId | 入居希望者, 部屋, 日時, 担当者 |
| 入居審査 (ScreeningApplication) | screeningId | 入居希望者, 部屋, 審査情報, 審査ステータス |
| 賃貸借契約 (LeaseContract) | contractId | 部屋, 入居者, 契約期間, 賃料, 管理費, 敷金, 礼金, 特約, ステータス |
| 家賃請求 (RentBilling) | billingId | 契約, 対象年月, 請求額, 入金ステータス, 入金日 |
| 退去精算 (MoveOutSettlement) | settlementId | 契約, 検査結果, 敷金額, 原状回復費用, 返還額or追加請求額 |

#### 値オブジェクト

| 値オブジェクト | 構成要素 | 理由 |
|---|---|---|
| 所在地 (Address) | 郵便番号, 都道府県, 市区町村, 番地, 建物名 | 属性の組で等価 |
| 間取り (FloorPlan) | タイプ名(1K/2LDK等) | 定型値 |
| 面積 (Area) | 数値, 単位(㎡) | バリデーション付きの値 |
| 金額 (Money) | 数値, 通貨 | 汎用値オブジェクト |
| 契約期間 (LeaseTerm) | 開始日, 終了日 | 期間を一体で扱う |
| 部屋ステータス (RoomStatus) | 空室/入居中/退去予定/リフォーム中 | 列挙型 |
| 契約ステータス (ContractStatus) | 契約中/更新済み/解約予告中/退去完了 | 列挙型 |
| 審査ステータス (ScreeningStatus) | 審査中/通過/否決 | 列挙型 |
| 入金ステータス (PaymentStatus) | 未請求/請求済み/入金確認済み/滞納 | 列挙型 |
| 審査情報 (ScreeningInfo) | 勤務先, 年収, 連帯保証人情報 | 審査に必要な情報の組 |
| 入居条件 (ListingCondition) | ペット可否, 楽器可否, その他 | 募集条件の組 |
| 損傷記録 (DamageRecord) | 箇所, 状態, 修繕費用, 写真 | 退去時検査の一行 |
| 精算明細 (SettlementLine) | 項目名, 金額 | 精算書の一行 |

#### 集約と境界の理由

| 集約ルート | 含まれるもの | 境界の理由・注意点 |
|---|---|---|
| **Property** | Property + Room | 部屋は物件に従属。部屋の追加・削除は物件管理の一部。**注意**: 大規模マンション（数百室）では Room を別集約に分離する選択肢もあるが、一般的な賃貸物件（数十室以内）なら問題ない。 |
| **Listing** | Listing 単体 | 募集は部屋に対して作成されるが、掲載・取り下げの独立したライフサイクルを持つ |
| **ViewingAppointment** | ViewingAppointment 単体 | 内見予約は独立したイベント |
| **ScreeningApplication** | ScreeningApplication + ScreeningInfo | 審査は入居希望者と部屋に紐づくが、審査プロセスとして独立 |
| **LeaseContract** | LeaseContract 単体 | 契約のライフサイクル（契約中→更新/解約→退去）を管理。賃料等の契約条件はスナップショット |
| **RentBilling** | RentBilling 単体 | 家賃請求は月次で個別に管理。入金確認・滞納管理は請求単位 |
| **MoveOutSettlement** | MoveOutSettlement + DamageRecord + SettlementLine | 退去精算と検査結果・明細は一体で管理 |
| **Owner** | Owner 単体 | オーナー情報は独立管理 |
| **Applicant** | Applicant 単体 | 入居希望者は独立管理 |

#### ドメインイベント

- `PropertyRegistered` — 物件が登録された
- `RoomListed` — 部屋が募集に出された
- `ViewingScheduled` — 内見が予約された
- `ScreeningSubmitted` — 入居審査が提出された
- `ScreeningApproved` — 審査通過
- `ScreeningRejected` — 審査否決
- `LeaseContractSigned` — 賃貸借契約が締結された（→ 部屋ステータスを「入居中」に変更）
- `RentBilled` — 家賃が請求された
- `RentPaymentConfirmed` — 家賃の入金が確認された
- `RentOverdue` — 家賃が滞納状態になった
- `RentReminderSent` — 滞納リマインダーが送信された（3日後）
- `RentDemandNoticeSent` — 督促通知が送信された（7日後）
- `LegalWarningIssued` — 法的措置警告が送信された（30日後）
- `LeaseTerminationNotified` — 解約予告が行われた（→ 部屋ステータスを「退去予定」に変更）
- `MoveOutInspectionCompleted` — 退去立会い検査が完了した
- `MoveOutSettled` — 退去精算が完了した（→ 部屋ステータスを「リフォーム中」or「空室」に変更）
- `LeaseRenewed` — 契約が更新された

#### ドメインサービス

| サービス | 責務 |
|---|---|
| **家賃請求生成サービス (RentBillingGenerationService)** | 月次バッチで全アクティブ契約から RentBilling を生成する。契約の賃料 + 管理費を合算。 |
| **滞納エスカレーションサービス (OverdueEscalationService)** | 未入金の RentBilling を監視し、経過日数に応じてリマインダー→督促→法的警告をトリガーする。スケジューラと連携。 |
| **退去精算サービス (MoveOutSettlementService)** | 検査結果（DamageRecord）から原状回復費用を算出し、敷金との差額を計算して精算書を生成する。LeaseContract（敷金情報）と MoveOutSettlement をまたぐ。 |
| **契約更新サービス (LeaseRenewalService)** | 契約期間満了前に更新手続きを行う。更新料の計算、新契約期間の設定。賃料改定がある場合は新賃料の適用。 |

#### 設計判断の解説

**1. 家賃滞納時のエスカレーション**

```
引落日 → RentBilled
  ├── 入金確認 → RentPaymentConfirmed → 完了
  └── 未入金
        ├── +3日 → RentReminderSent（リマインダー）
        ├── +7日 → RentDemandNoticeSent（督促通知）
        └── +30日 → LegalWarningIssued（法的措置警告）
```

- RentBilling を独立集約にする理由: 家賃請求は月次で大量に発生し、個別に入金確認・滞納管理される。契約集約に含めると契約期間中の全請求を抱えることになり肥大化する
- エスカレーションは OverdueEscalationService がスケジューラと連携して実行。各ステップでイベントを発行し、通知システムと連携する
- 滞納履歴は RentBilling のステータスと入金日で追跡可能。別途「滞納サマリ」が必要なら、RentBilling のクエリで集計するか、非正規化して入居者に保持

**2. 退去精算のフロー**

```
解約予告 (LeaseTerminationNotified)
  → 部屋ステータス: 入居中 → 退去予定
  → 退去日の確定

退去日当日:
  立会い検査 → DamageRecord を記録
  → MoveOutInspectionCompleted

精算計算 (MoveOutSettlementService):
  原状回復費用 = Σ DamageRecord の修繕費用
  if 敷金 >= 原状回復費用:
    返還額 = 敷金 - 原状回復費用
  else:
    追加請求額 = 原状回復費用 - 敷金
  → 精算書 (SettlementLine) 生成
  → MoveOutSettled

  → 部屋ステータス: 退去予定 → リフォーム中 or 空室
```

- MoveOutSettlement を独立集約にする理由: 精算は退去時の一回限りのプロセスだが、検査結果と精算明細を含む複合的なデータ。契約集約に含めると、精算データが契約のライフサイクルと結合する
- 敷金額は LeaseContract に記録されたスナップショットを参照。MoveOutSettlement にも敷金額をコピーして自己完結させる
