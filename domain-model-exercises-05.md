# ドメインモデル抽出 — 練習問題と模範解答（第5回）

---

## 【問題 1】初級 — ペットホテル予約システム

### 要件

> ペットホテルの予約管理システムを設計してください。
>
> - 飼い主はアカウントを作成し、ペット情報を登録する。1人の飼い主が複数のペットを登録できる。
> - ペットには名前、種類（犬/猫/小動物）、犬種・猫種、体重、生年月日、ワクチン接種状況がある。
> - ペットホテルには複数の部屋タイプがある（個室/大部屋/スイートルーム等）。各部屋タイプには1泊あたりの料金と収容可能なペットの種類・体重制限がある。
> - 各部屋タイプには部屋数の上限がある。同じ日に同じ部屋タイプの予約が上限を超えることはできない。
> - 飼い主はペットを選択し、チェックイン日・チェックアウト日を指定して予約する。1回の予約で複数のペットを預けられるが、各ペットに部屋が1つずつ割り当てられる。
> - 予約時に合計金額（部屋料金 × 泊数 × ペット数）が計算される。
> - 追加サービス（トリミング、散歩追加、写真レポート等）をオプションで申し込める。各サービスには料金がある。
> - 予約ステータスは「予約確定」→「チェックイン済み」→「チェックアウト済み」と遷移する。予約確定からはキャンセルも可能。
> - チェックイン時にペットの健康状態を記録する（体温、外見の異常、持病メモ等）。
> - チェックアウト時に最終的な請求金額が確定する（追加サービスの実績を含む）。

**問い**: エンティティ、値オブジェクト、集約、ドメインイベントを抽出してください。

---

### 模範解答 1

#### エンティティ

| エンティティ | 識別子 | 主な属性・関連 |
|---|---|---|
| 飼い主 (Owner) | ownerId | 氏名, 電話番号, メールアドレス |
| ペット (Pet) | petId | 名前, 種類, 犬種・猫種, 体重, 生年月日, ワクチン接種状況, 飼い主 |
| 部屋タイプ (RoomType) | roomTypeId | タイプ名, 1泊料金, 部屋数上限, 対応ペット種類, 体重制限 |
| 予約 (Reservation) | reservationId | 飼い主, 宿泊期間, 予約明細リスト, 追加サービスリスト, ステータス, 合計金額 |

#### 値オブジェクト

| 値オブジェクト | 構成要素 | 理由 |
|---|---|---|
| 宿泊期間 (StayPeriod) | チェックイン日, チェックアウト日, 泊数 | 期間を一体として扱う。泊数の算出ロジックを持てる |
| 予約明細 (ReservationLine) | ペット(への参照), 部屋タイプ(への参照), 1泊料金(スナップショット), 泊数, 小計 | ペットと部屋の組。予約時の料金を保持 |
| 追加サービス (AdditionalService) | サービス名, 料金, 対象ペット, 実施済みフラグ | オプションサービスの一行 |
| 予約ステータス (ReservationStatus) | 予約確定/チェックイン済み/チェックアウト済み/キャンセル | 列挙型 |
| ワクチン接種状況 (VaccinationRecord) | ワクチン名, 接種日, 有効期限 | ペットの接種記録 |
| 健康チェック (HealthCheck) | 体温, 外見の異常, 持病メモ, 記録日時 | チェックイン時の記録 |
| 金額 (Money) | 数値, 通貨 | 汎用値オブジェクト |
| 体重 (Weight) | 数値, 単位(kg) | バリデーション付きの値 |
| ペット種類 (PetSpecies) | 犬/猫/小動物 | 列挙型 |

#### 集約

| 集約ルート | 含まれるもの | 整合性のルール |
|---|---|---|
| **Owner** | Owner + Pet + VaccinationRecord | 飼い主とペットは強い従属関係。ペットの登録・更新は飼い主を通じて行う |
| **RoomType** | RoomType 単体 | 部屋タイプのマスタ情報。料金・制限の管理 |
| **Reservation** | Reservation + ReservationLine + AdditionalService + HealthCheck | 予約の整合性（合計金額、ステータス遷移）を一体で管理。予約明細・追加サービス・健康チェックは予約のライフサイクルに従属 |

#### ドメインイベント

- `PetRegistered` — ペットが登録された
- `ReservationCreated` — 予約が作成された
- `ReservationCancelled` — 予約がキャンセルされた
- `PetCheckedIn` — チェックインが完了した（→ 健康チェック記録）
- `PetCheckedOut` — チェックアウトが完了した（→ 最終請求額確定）
- `AdditionalServiceCompleted` — 追加サービスが実施された

#### 解説ポイント

- **Owner 集約に Pet を含める判断**: ペットは飼い主なしに存在しない。飼い主の退会時にペット情報も一緒に削除されるべき。ペット数は通常1〜5匹程度で集約が肥大化するリスクは低い。
- **部屋の空き判定**: 「同じ日に同じ部屋タイプの予約が上限を超えない」はドメインの重要な不変条件。RoomType 集約には部屋数上限があり、予約時に既存予約数をカウントして空き判定する。この判定は集約をまたぐため、ドメインサービス（空室確認サービス）として切り出すのも妥当。
- **料金スナップショット**: 部屋タイプの料金は変更される可能性がある。ReservationLine に予約時点の1泊料金を保持することで、後からの料金変更で過去の予約金額が変わらない。

---

## 【問題 2】中級 — オンライン試験プラットフォーム

### 要件

> オンラインで試験を実施・管理するプラットフォームを設計してください。
>
> - 試験管理者は試験を作成する。試験にはタイトル、説明、制限時間、合格スコア、公開期間（開始日時・終了日時）がある。
> - 試験には複数のセクションがあり、各セクションに複数の問題がある。セクションには名前と配点比率がある。
> - 問題には以下の種別がある:
>   - 選択式（単一選択/複数選択）: 選択肢リストと正解
>   - 記述式: 模範解答とキーワードリスト（自動採点用）
>   - 穴埋め式: 文中の空欄と正解テキスト
> - 各問題には配点がある。試験全体の満点はセクション内の問題の配点合計から算出される。
> - 受験者は公開期間中に試験を受験できる。受験を開始すると制限時間のカウントダウンが始まる。
> - 受験者は回答を途中保存できる。制限時間を超過すると、その時点の回答で自動提出される。
> - 提出後、選択式と穴埋め式は自動採点される。記述式はキーワードマッチによる仮スコアが算出されるが、最終スコアは試験管理者が手動で確定する。
> - 全問の採点が確定すると、合計スコアと合否が判定され、受験者に結果が通知される。
> - 試験管理者は受験者ごとの回答内容、スコア、所要時間を確認できる。
> - 不正行為防止のため、受験中に別タブに移動した回数が記録される。一定回数を超えると警告が出され、試験管理者にも通知される。
> - 同一の試験を複数回受験できるかどうかは試験ごとに設定可能。再受験可能な場合、最高スコアが採用される。

**問い**: エンティティ、値オブジェクト、集約（境界の理由も）、ドメインイベント、ドメインサービスを抽出してください。

---

### 模範解答 2

#### エンティティ

| エンティティ | 識別子 | 主な属性・関連 |
|---|---|---|
| 試験管理者 (ExamAdmin) | adminId | 氏名, メールアドレス |
| 試験 (Exam) | examId | タイトル, 説明, 制限時間, 合格スコア, 公開期間, 再受験可否, 管理者 |
| セクション (Section) | sectionId | セクション名, 配点比率, 表示順序 |
| 問題 (Question) | questionId | 問題文, 種別, 配点, 表示順序 |
| 受験者 (Examinee) | examineeId | 氏名, メールアドレス |
| 受験 (Attempt) | attemptId | 受験者, 試験, 開始日時, 提出日時, 制限時間超過フラグ, 採点ステータス, 合計スコア, 合否 |
| 回答 (Answer) | answerId | 問題(への参照), 回答内容, 自動スコア, 最終スコア, 採点確定フラグ |

#### 値オブジェクト

| 値オブジェクト | 構成要素 | 理由 |
|---|---|---|
| 公開期間 (PublicationPeriod) | 開始日時, 終了日時 | 期間を一体で扱う |
| 制限時間 (TimeLimit) | 分数 | バリデーション付き（正の整数） |
| 合格スコア (PassingScore) | 数値（点数 or 百分率） | 合否判定の閾値 |
| 配点 (Score) | 数値 | 問題の配点 |
| 配点比率 (WeightRatio) | 数値（0〜1 or 百分率） | セクションの重み |
| 選択肢 (Choice) | 選択肢テキスト, 正解フラグ | 選択式問題の一選択肢 |
| キーワード (Keyword) | テキスト, 配点比率 | 記述式の自動採点用 |
| 穴埋め箇所 (BlankSlot) | 空欄位置, 正解テキスト | 穴埋め式の一空欄 |
| 回答内容 (AnswerContent) | 選択した選択肢 / 記述テキスト / 穴埋めテキスト | 問題種別に応じた多態的な値 |
| 採点ステータス (GradingStatus) | 自動採点済み/手動採点中/確定済み | 列挙型 |
| 合否 (PassFailResult) | 合格/不合格 | 列挙型 |
| タブ離脱記録 (TabSwitchLog) | 離脱回数, 最終離脱日時 | 不正行為監視の値 |

#### 集約と境界の理由

| 集約ルート | 含まれるもの | 境界の理由 |
|---|---|---|
| **Exam** | Exam + Section + Question (+ Choice / Keyword / BlankSlot) | 試験の定義はセクション・問題と一体。問題の追加・削除・並び替えは試験全体の整合性（満点の算出、配点比率の合計=100%）に影響する。試験公開前に一貫した状態で確定される。 |
| **Attempt** | Attempt + Answer + TabSwitchLog | 受験とその回答群は一体のライフサイクル。「全回答の採点確定 → 合計スコア算出 → 合否判定」は Attempt 集約内で整合性を保つ。タブ離脱記録も受験に従属する。 |
| **Examinee** | Examinee 単体 | 受験者情報は独立管理 |
| **ExamAdmin** | ExamAdmin 単体 | 管理者情報は独立管理 |

#### ドメインイベント

- `ExamCreated` — 試験が作成された
- `ExamPublished` — 試験が公開された
- `AttemptStarted` — 受験が開始された（→ タイマー開始）
- `AnswerSaved` — 回答が途中保存された
- `AttemptSubmitted` — 回答が提出された（手動提出）
- `AttemptAutoSubmitted` — 制限時間超過で自動提出された
- `AutoGradingCompleted` — 選択式・穴埋め式の自動採点が完了した
- `ManualGradingCompleted` — 記述式の手動採点が確定した
- `AllGradingFinalized` — 全問の採点が確定した（→ 合否判定・結果通知トリガー）
- `ResultNotified` — 受験者に結果が通知された
- `TabSwitchWarningTriggered` — タブ離脱が一定回数を超えた（→ 受験者への警告・管理者通知）
- `SuspiciousBehaviorDetected` — 不正行為の疑いが検出された

#### ドメインサービス

| サービス | 責務 |
|---|---|
| **自動採点サービス (AutoGradingService)** | 提出された回答に対し、問題種別ごとの採点ロジックを実行する。選択式: 正解との一致判定。穴埋め式: 正解テキストとの一致（表記揺れ考慮）。記述式: キーワードマッチによる仮スコア算出。Exam 集約（正解情報）と Attempt 集約（回答）をまたぐ。 |
| **合否判定サービス (PassFailJudgementService)** | 全問の最終スコアが確定した後、セクションの配点比率を加味して合計スコアを算出し、合格スコアと比較して合否を判定する。 |
| **再受験可否判定サービス (RetakeEligibilityService)** | 受験者が試験を再受験できるかを判定する。試験の再受験可否設定と、既存の Attempt 数を確認する。 |
| **不正行為監視サービス (CheatingDetectionService)** | タブ離脱回数を監視し、閾値超過時に警告イベントを発行する。受験セッションとリアルタイムで連携。 |

#### 解説ポイント

- **Exam 集約が大きくなるリスク**: 問題数が多い試験（100問以上）では集約のサイズが大きくなる。ただし、試験定義は「公開前に編集→公開後は不変」というライフサイクルなので、公開後の同時更新競合はない。編集フェーズでも1人の管理者が操作するため、実質的な問題は少ない。
- **Attempt に Answer を含める理由**: 「全回答の採点確定」を判定するには全 Answer の状態を把握する必要がある。Answer を別集約にすると、この判定が結果整合性になり複雑化する。1回の受験の回答数は問題数と同じ（通常数十〜百程度）で、サイズとしては許容範囲。
- **自動採点と手動採点の非対称性**: 選択式・穴埋め式は提出直後に自動採点できるが、記述式は管理者の手動確定を待つ必要がある。この非対称性を GradingStatus で管理し、全問が「確定済み」になったときに `AllGradingFinalized` を発行する。
- **最高スコアの管理**: 再受験可能な試験では、受験者の「最高スコア」を追跡する必要がある。これを Examinee に持たせるか、Attempt のクエリで都度算出するかは読み取り要件による。頻繁に参照するなら非正規化して保持、そうでなければクエリで算出。

---

## 【問題 3】上級 — マーケットプレイス型人材マッチングプラットフォーム

### 要件

> 企業とフリーランスをマッチングするプラットフォームを設計してください。
>
> **プロフィール・案件管理**
> - フリーランスはプロフィールを作成する。プロフィールにはスキル（複数。各スキルに経験年数）、自己紹介、希望単価（時給/日給/月給を選択）、稼働可能時間（週○時間）、ポートフォリオ（URLリスト）がある。
> - 企業は案件を作成する。案件にはタイトル、説明、必須スキル（各スキルに最低経験年数）、歓迎スキル、予算レンジ（単価の下限・上限）、稼働量（週○時間）、契約期間（開始予定日・終了予定日）、募集人数がある。
> - 案件のステータスは「下書き」→「公開中」→「募集終了」と遷移する。
>
> **応募・マッチング**
> - フリーランスは案件に応募する。応募時に希望単価と自己PR文を添える。
> - 企業は応募者一覧を確認し、「書類通過」「面談依頼」「不採用」を選択できる。
> - 面談後、企業は「オファー」または「不採用」を決定する。オファーには提示単価、契約期間、稼働条件が含まれる。
> - フリーランスはオファーを「承諾」または「辞退」できる。
>
> **契約・稼働管理**
> - オファー承諾後、契約が成立する。契約には確定した単価、契約期間、稼働条件が含まれる。
> - フリーランスは日次で稼働時間を報告する。報告には日付、稼働時間、作業内容がある。
> - 企業は報告された稼働時間を「承認」または「差し戻し」できる。
> - 稼働時間は月次で集計され、請求書が自動生成される。請求額は「承認済み稼働時間 × 単価」で計算される。
> - プラットフォーム手数料（15%）が差し引かれ、フリーランスに支払われる。
>
> **評価・レピュテーション**
> - 契約終了後、企業とフリーランスが相互に評価する（5段階＋コメント）。
> - フリーランスの「マッチングスコア」が各案件に対して算出される。スコアはスキル一致度、経験年数、過去の評価、単価の予算適合度から計算される。
> - 企業は案件に対してマッチングスコア順でフリーランスをスカウト（直接オファー）できる。

**問い**: エンティティ、値オブジェクト、集約（境界の理由と注意点）、ドメインイベント、ドメインサービスを抽出してください。特に「応募からオファー承諾までのステート管理」「稼働報告と月次請求のフロー」「マッチングスコアの算出」の設計判断を説明してください。

---

### 模範解答 3

#### エンティティ

| エンティティ | 識別子 | 主な属性・関連 |
|---|---|---|
| フリーランス (Freelancer) | freelancerId | 氏名, メールアドレス, プロフィール |
| 企業 (Company) | companyId | 企業名, 担当者名, メールアドレス |
| 案件 (Job) | jobId | タイトル, 説明, 必須スキル, 歓迎スキル, 予算レンジ, 稼働量, 契約期間, 募集人数, ステータス, 企業 |
| 応募 (Application) | applicationId | フリーランス, 案件, 希望単価, 自己PR, 選考ステータス |
| オファー (Offer) | offerId | 応募(への参照), 提示単価, 契約期間, 稼働条件, オファーステータス |
| 契約 (Contract) | contractId | フリーランス, 企業, 案件, 確定単価, 契約期間, 稼働条件, 契約ステータス |
| 稼働報告 (TimeEntry) | entryId | 契約, 日付, 稼働時間, 作業内容, 承認ステータス |
| 請求書 (Invoice) | invoiceId | 契約, 請求期間, 請求明細, 合計金額, 手数料, 支払金額, 請求ステータス |
| 評価 (Review) | reviewId | 契約, 評価者, 被評価者, 星評価, コメント |

#### 値オブジェクト

| 値オブジェクト | 構成要素 | 理由 |
|---|---|---|
| スキル (Skill) | スキル名, 経験年数 | フリーランスのスキル一行 |
| 必須スキル要件 (RequiredSkill) | スキル名, 最低経験年数 | 案件の要件一行 |
| 希望単価 (DesiredRate) | 金額, 単位(時給/日給/月給) | 金額と単位の組 |
| 予算レンジ (BudgetRange) | 下限金額, 上限金額, 単位 | 範囲を一体で扱う |
| 契約期間 (ContractPeriod) | 開始日, 終了日 | 期間を一体で扱う |
| 稼働条件 (WorkCondition) | 週あたり稼働時間, リモート可否 等 | 条件の組 |
| ポートフォリオ (Portfolio) | URLリスト | フリーランスの実績参照 |
| 金額 (Money) | 数値, 通貨 | 汎用値オブジェクト |
| 選考ステータス (ScreeningStatus) | 応募中/書類通過/面談中/オファー済み/不採用 | 列挙型 |
| オファーステータス (OfferStatus) | 提示中/承諾/辞退/期限切れ | 列挙型 |
| 契約ステータス (ContractStatus) | 稼働中/完了/途中解約 | 列挙型 |
| 承認ステータス (ApprovalStatus) | 未承認/承認済み/差し戻し | 列挙型 |
| 請求ステータス (InvoiceStatus) | 下書き/確定/支払済み | 列挙型 |
| 請求明細 (InvoiceLineItem) | 日付, 稼働時間, 単価, 小計 | 請求書の一行 |
| 手数料 (PlatformFee) | 料率(15%), 金額 | ビジネスルールの明示化 |
| マッチングスコア (MatchingScore) | スコア値, スキル一致度, 経験スコア, 評価スコア, 単価適合度 | 算出結果と内訳 |

#### 集約と境界の理由

| 集約ルート | 含まれるもの | 境界の理由・注意点 |
|---|---|---|
| **Freelancer** | Freelancer + Skill リスト + Portfolio | プロフィール情報は一体で管理。スキルの追加・削除はフリーランスの操作。スキル数は通常数十件以内で肥大化リスクは低い。 |
| **Company** | Company 単体 | 企業情報は独立管理 |
| **Job** | Job + RequiredSkill + 歓迎スキル | 案件の定義情報は一体。必須スキル要件は案件に従属する。募集人数の管理もここ。 |
| **Application** | Application 単体 | 応募は独立したライフサイクル（応募→選考→結果）。案件やフリーランスとは参照関係。**注意**: Application と Offer を同一集約にするか分離するかは判断ポイント（後述）。 |
| **Offer** | Offer 単体 | オファーは応募の選考プロセスから派生するが、独立した承諾/辞退のライフサイクルを持つ。Application とは参照関係。 |
| **Contract** | Contract 単体 | 契約は成立後に独立したライフサイクル（稼働中→完了/途中解約）を持つ。案件・フリーランス・企業への参照を保持するが、それぞれとは独立。 |
| **TimeEntry** | TimeEntry 単体 | 稼働報告は高頻度で作成される。契約集約に含めると更新が集中する。個別に承認/差し戻しが行われるため独立集約が適切。 |
| **Invoice** | Invoice + InvoiceLineItem | 請求書と明細は一体で確定。承認済みの TimeEntry を集計して生成されるが、生成後は独立。 |
| **Review** | Review 単体 | 評価は契約終了後に作成。独立したライフサイクル。 |

#### Application と Offer の分離判断

**案A: Application に Offer を含める**
- メリット: 「応募→選考→オファー→承諾」の一連のフローが1集約で完結。整合性が保ちやすい
- デメリット: Application 集約が複数の責務（選考管理 + オファー管理）を持つ。オファーの有効期限管理など、Application とは無関係なロジックが混入する

**案B: Application と Offer を分離する（本解答の採用案）**
- メリット: 各集約が単一責務。Offer のステータス管理（承諾待ち→承諾/辞退/期限切れ）が独立して扱える
- デメリット: 「オファー承諾 → Application のステータスも更新」が集約をまたぐ。イベント駆動で結果整合性を取る必要がある

小規模なら案A、選考フローが複雑化する見込みがあれば案Bが適切。

#### ドメインイベント

**応募・選考フロー:**
- `ApplicationSubmitted` — 応募が提出された
- `ApplicationScreeningPassed` — 書類通過した
- `InterviewRequested` — 面談が依頼された
- `OfferExtended` — オファーが提示された
- `OfferAccepted` — オファーが承諾された（→ 契約作成トリガー）
- `OfferDeclined` — オファーが辞退された
- `ApplicationRejected` — 不採用になった

**契約・稼働フロー:**
- `ContractStarted` — 契約が開始された
- `TimeEntrySubmitted` — 稼働報告が提出された
- `TimeEntryApproved` — 稼働報告が承認された
- `TimeEntryRejected` — 稼働報告が差し戻された
- `MonthlyInvoiceGenerated` — 月次請求書が生成された
- `InvoicePaid` — 請求書の支払いが完了した
- `FreelancerPaid` — フリーランスへの支払いが完了した
- `ContractCompleted` — 契約が完了した
- `ContractTerminatedEarly` — 契約が途中解約された

**評価:**
- `ReviewPosted` — 評価が投稿された
- `MutualReviewCompleted` — 双方の評価が揃った

#### ドメインサービス

| サービス | 責務 |
|---|---|
| **マッチングスコア算出サービス (MatchingScoreCalculator)** | フリーランスのスキル・経験年数・過去評価と案件の要件・予算を照合し、スコアを算出する。Freelancer 集約と Job 集約を横断的に参照する。 |
| **月次請求書生成サービス (MonthlyInvoiceGenerator)** | 月末に契約ごとの承認済み TimeEntry を集計し、Invoice を生成する。Contract（単価情報）+ TimeEntry（稼働実績）+ 手数料率を参照する。 |
| **フリーランス支払サービス (FreelancerPaymentService)** | 請求書の入金確認後、手数料を差し引いた金額をフリーランスに支払う。外部決済連携。冪等性が必須。 |
| **契約生成サービス (ContractCreationService)** | OfferAccepted イベントを受けて Contract を生成する。Offer の提示条件（単価、契約期間、稼働条件）をスナップショットとして Contract に記録する。 |
| **募集人数管理サービス (HeadcountManagementService)** | オファー承諾時に案件の「残り募集人数」を確認・減算する。募集人数に達した場合、案件ステータスを「募集終了」に遷移させる。Job 集約と Offer/Contract をまたぐ。 |

#### 設計判断の解説

**1. 応募からオファー承諾までのステート管理**

```
フリーランス          プラットフォーム              企業
    |                                              |
    |--- 応募(ApplicationSubmitted) -------------→ |
    |                                              |--- 書類選考
    |                                              |
    |←--- 書類通過(ScreeningPassed) --------------|
    |     or 不採用(ApplicationRejected) ---------|
    |                                              |
    |←--- 面談依頼(InterviewRequested) -----------|
    |                                              |
    |     [面談実施（プラットフォーム外）]            |
    |                                              |
    |←--- オファー(OfferExtended) ----------------|
    |                                              |
    |--- 承諾(OfferAccepted) ------------------→  |
    |    or 辞退(OfferDeclined)                    |
    |                                              |
    |         [ContractCreationService]             |
    |                                              |
    |←--- 契約開始(ContractStarted) --------------|
```

- Application の選考ステータスと Offer のオファーステータスは別々に管理する
- Application の ScreeningStatus は企業側の選考進捗を表す
- Offer の OfferStatus はフリーランス側の意思決定を表す
- この分離により、将来「同一案件に複数オファーを出す」「オファー交渉（条件変更）」などの拡張が容易

**2. 稼働報告と月次請求のフロー**

```
日次:
  フリーランス → TimeEntrySubmitted → 企業が確認
                                        ├── TimeEntryApproved
                                        └── TimeEntryRejected → 修正して再提出

月末バッチ:
  MonthlyInvoiceGenerator
    → Contract から単価を取得
    → 当月の承認済み TimeEntry を集計
    → 請求額 = Σ(稼働時間 × 単価)
    → 手数料 = 請求額 × 15%
    → 支払額 = 請求額 - 手数料
    → Invoice 生成 (InvoiceGenerated)

企業の入金確認後:
    → InvoicePaid
    → FreelancerPaymentService → FreelancerPaid
```

- TimeEntry を独立集約にする理由: 日次で作成され、個別に承認/差し戻しが行われる。Contract 集約に含めると、契約期間中の全稼働報告を抱えることになり肥大化する
- 未承認の TimeEntry は請求対象にならない。月末集計時に「承認済み」のみをフィルタリングする
- 差し戻された TimeEntry は修正して再提出可能。元のエントリを更新するか新規作成するかは要件次第（監査証跡が必要なら新規作成 + 差し戻し元への参照）

**3. マッチングスコアの算出**

```
スコア = w1 × スキル一致度 + w2 × 経験スコア + w3 × 評価スコア + w4 × 単価適合度

スキル一致度:
  必須スキルの充足率 + 歓迎スキルのボーナス
  例: 必須3スキル中3つ保有 → 100%、2つ → 67%

経験スコア:
  各必須スキルの (実際の経験年数 / 要求経験年数) の平均
  上限あり（要求3年に対して10年でも上限スコア）

評価スコア:
  過去の契約での平均評価（5段階）を正規化

単価適合度:
  フリーランスの希望単価が予算レンジ内なら高スコア
  レンジ外でも近ければ部分スコア
```

- マッチングスコアは **算出のたびに最新データから計算する**（キャッシュしない）。フリーランスのスキルや評価が更新されるたびにスコアが変わるため
- ただし、スカウト画面で大量のフリーランスに対して算出するため、パフォーマンスが問題になる場合は **事前計算 + 定期更新** の戦略も検討する
- スコアの算出ロジック（重み w1〜w4 など）はビジネス要件で頻繁に調整される。ドメインサービス内にポリシーオブジェクトとして分離しておくと変更に強い

---

## 総合チェックリスト（第5回追加項目含む）

| # | チェック項目 |
|---|---|
| 1 | 要件中の主要な名詞をすべて検討したか |
| 2 | エンティティと値オブジェクトの区別は「一意に追跡する必要があるか」で判断したか |
| 3 | 集約の境界は「一緒に変更されるもの」で引けているか |
| 4 | 集約が大きすぎて更新競合のリスクはないか |
| 5 | ステータス遷移を列挙型の値オブジェクトで表現しているか |
| 6 | 時点で変わるデータのスナップショットを取っているか |
| 7 | 外部システム連携の情報を値オブジェクトで保持しているか |
| 8 | 集約をまたぐロジックをドメインサービスに切り出しているか |
| 9 | 結果整合性が必要な箇所を特定し、ドメインイベントで繋いでいるか |
| 10 | 冪等性・リトライが必要な処理を意識しているか |
| 11 | 時間に依存する処理の実現方法を考えたか |
| 12 | バッチ処理 vs リアルタイム処理の判断は適切か |
| 13 | マスタデータとトランザクションデータを区別しているか |
| 14 | 状態遷移が複数段階にまたがる場合のオーケストレーションを設計したか |
| 15 | 集約内の要素が肥大化するリスクを検討したか |
| 16 | カスタマイズ可能なルールと実データの整合性を考えたか |
| 17 | 多対多の関係を参照で表現しているか |
| 18 | 採番・連番の一意性保証の方法を考えたか |
| 19 | **集約の分離/統合の代替案**を比較検討したか（メリット・デメリットの明示） |
| 20 | **算出値（スコア等）の計算タイミング**（リアルタイム vs 事前計算 vs 遅延計算）を検討したか |
| 21 | **選考・承認のような多段階プロセス**のステート管理方法を設計したか |
